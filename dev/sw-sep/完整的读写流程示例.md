# OpenSearch è¯»å†™åˆ†ç¦»å®Œæ•´æµç¨‹ç¤ºä¾‹

> æœ¬æ–‡æ¡£é€šè¿‡ä¸€ä¸ªå…·ä½“çš„æ–‡æ¡£ç¤ºä¾‹ï¼Œå®Œæ•´å±•ç¤ºä»å†™å…¥ä¸»åˆ†ç‰‡ã€åŒæ­¥å‰¯æœ¬åˆ†ç‰‡ã€åˆ°æœç´¢å‰¯æœ¬æŸ¥è¯¢çš„å…¨æµç¨‹

---

## ğŸ“‹ ç¤ºä¾‹åœºæ™¯è®¾ç½®

### é›†ç¾¤é…ç½®

```yaml
# é›†ç¾¤æ‹“æ‰‘
èŠ‚ç‚¹é…ç½®:
  - node-1: [master, data]           # ä¸»åˆ†ç‰‡æ‰€åœ¨èŠ‚ç‚¹
  - node-2: [data]                   # å†™å‰¯æœ¬æ‰€åœ¨èŠ‚ç‚¹
  - node-3: [data, search]           # æœç´¢å‰¯æœ¬æ‰€åœ¨èŠ‚ç‚¹
  - node-4: [data, search]           # æœç´¢å‰¯æœ¬æ‰€åœ¨èŠ‚ç‚¹

è¿œç¨‹å­˜å‚¨:
  - ç±»å‹: AWS S3
  - å­˜å‚¨æ¡¶: opensearch-remote-store
  - åŒºåŸŸ: us-east-1
```

### ç´¢å¼•é…ç½®

```json
PUT /products
{
  "settings": {
    "index": {
      "number_of_shards": 1,
      "number_of_replicas": 1,              // 1ä¸ªå†™å‰¯æœ¬
      "number_of_search_replicas": 2,       // 2ä¸ªæœç´¢å‰¯æœ¬
      "replication.type": "SEGMENT",
      "remote_store.enabled": true,
      "remote_store.segment.repository": "s3-repo",
      "remote_store.translog.repository": "s3-repo",
      "refresh_interval": "5s"
    }
  },
  "mappings": {
    "properties": {
      "name": { "type": "text" },
      "price": { "type": "float" },
      "category": { "type": "keyword" }
    }
  }
}
```

### åˆ†ç‰‡åˆ†é…

```
ç´¢å¼•: products
  â”œâ”€ [products][0] - Primary Shard     @ node-1
  â”œâ”€ [products][0] - Write Replica     @ node-2
  â”œâ”€ [products][0] - Search Replica #1 @ node-3
  â””â”€ [products][0] - Search Replica #2 @ node-4
```

---

## ğŸš€ å®Œæ•´æµç¨‹ï¼šå†™å…¥ä¸æŸ¥è¯¢

### æ—¶é—´çº¿æ€»è§ˆ

```
T0    å®¢æˆ·ç«¯å‘èµ·å†™å…¥è¯·æ±‚
T1    ä¸»åˆ†ç‰‡å†™å…¥æ–‡æ¡£åˆ°å†…å­˜
T2    ä¸»åˆ†ç‰‡å†™å…¥ translog
T3    è¿”å›å†™å…¥æˆåŠŸ
T4    å¼‚æ­¥å¤åˆ¶ translog åˆ°å†™å‰¯æœ¬ï¼ˆå¯é€‰ï¼‰
T5    ä¸»åˆ†ç‰‡æ‰§è¡Œ refreshï¼ˆ5ç§’åï¼‰
T6    ä¸»åˆ†ç‰‡ç”Ÿæˆæ–°çš„ Lucene segment
T7    ä¸»åˆ†ç‰‡ä¸Šä¼  segment åˆ° S3
T8    ä¸»åˆ†ç‰‡å‘å¸ƒæ£€æŸ¥ç‚¹åˆ°å†™å‰¯æœ¬
T9    å†™å‰¯æœ¬ä»ä¸»åˆ†ç‰‡æ‹‰å– segment
T10   å†™å‰¯æœ¬å®Œæˆå¤åˆ¶

      [å¹¶è¡Œè·¯å¾„]
T11   ä¸»åˆ†ç‰‡å‘å¸ƒæ£€æŸ¥ç‚¹åˆ°æœç´¢å‰¯æœ¬
T12   æœç´¢å‰¯æœ¬ä» S3 æ‹‰å– segment
T13   æœç´¢å‰¯æœ¬å®Œæˆå¤åˆ¶

T14   å®¢æˆ·ç«¯å‘èµ·æŸ¥è¯¢è¯·æ±‚
T15   åè°ƒèŠ‚ç‚¹è·¯ç”±åˆ°æœç´¢å‰¯æœ¬
T16   æœç´¢å‰¯æœ¬æ‰§è¡ŒæŸ¥è¯¢
T17   è¿”å›æŸ¥è¯¢ç»“æœ
```

---

## ğŸ“ é˜¶æ®µ 1ï¼šå†™å…¥ä¸»åˆ†ç‰‡ (T0-T3)

### 1.1 å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚

```bash
# T0: å®¢æˆ·ç«¯å‘é€ PUT è¯·æ±‚
POST /products/_doc/1
{
  "name": "Laptop",
  "price": 999.99,
  "category": "Electronics"
}
```

### 1.2 ä¸»åˆ†ç‰‡å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              T0-T3: ä¸»åˆ†ç‰‡å†™å…¥æµç¨‹                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[å®¢æˆ·ç«¯]              [åè°ƒèŠ‚ç‚¹]           [ä¸»åˆ†ç‰‡@node-1]
    â”‚
    â”‚ T0: POST /products/_doc/1
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
    â”‚                     â”‚
    â”‚                     â”‚ è·¯ç”±è®¡ç®—
    â”‚                     â”‚ hash(doc_id) % num_shards
    â”‚                     â”‚ = shard[0]
    â”‚                     â”‚
    â”‚                     â”‚ è½¬å‘åˆ°ä¸»åˆ†ç‰‡
    â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
    â”‚                     â”‚                       â”‚
    â”‚                     â”‚                       â”‚ T1: å†™å…¥å†…å­˜
    â”‚                     â”‚                       â”œâ”€â”€> InternalEngine.index()
    â”‚                     â”‚                       â”‚    â”‚
    â”‚                     â”‚                       â”‚    â”œâ”€> IndexWriter.addDocument()
    â”‚                     â”‚                       â”‚    â”‚   å†™å…¥å†…å­˜ç¼“å†²åŒº
    â”‚                     â”‚                       â”‚    â”‚
    â”‚                     â”‚                       â”‚    â””â”€> æ›´æ–°ç‰ˆæœ¬å·
    â”‚                     â”‚                       â”‚        versionMap.put(id, version)
    â”‚                     â”‚                       â”‚
    â”‚                     â”‚                       â”‚ T2: å†™å…¥ translog
    â”‚                     â”‚                       â”œâ”€â”€> Translog.add()
    â”‚                     â”‚                       â”‚    â”‚
    â”‚                     â”‚                       â”‚    â”œâ”€> å†™å…¥ç£ç›˜
    â”‚                     â”‚                       â”‚    â”‚   translog-xxx.tlog
    â”‚                     â”‚                       â”‚    â”‚
    â”‚                     â”‚                       â”‚    â””â”€> fsync()ï¼ˆå¯é€‰ï¼‰
    â”‚                     â”‚                       â”‚        ç¡®ä¿æŒä¹…åŒ–
    â”‚                     â”‚                       â”‚
    â”‚                     â”‚  T3: è¿”å›æˆåŠŸ          â”‚
    â”‚                     â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                     â”‚  { _id: 1, result: created }
    â”‚                     â”‚                       â”‚
    â”‚  T3: è¿”å›æˆåŠŸ       â”‚                       â”‚
    â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
    â”‚  { _id: 1, result: created }              â”‚
```

### 1.3 å…³é”®ä»£ç è·¯å¾„

```java
// server/src/main/java/org/opensearch/index/shard/IndexShard.java

public IndexResult index(Engine.Index operation) {
    // T1: å†™å…¥å†…å­˜
    Engine.IndexResult result = engine.index(operation);

    // T2: å†™å…¥ translogï¼ˆåœ¨ InternalEngine å†…éƒ¨ï¼‰
    // translog.add(new Translog.Index(...))

    return result;
}
```

```java
// server/src/main/java/org/opensearch/index/engine/InternalEngine.java

@Override
public IndexResult index(Index index) {
    try {
        // T1: Lucene IndexWriter å†™å…¥å†…å­˜
        indexWriter.addDocument(index.docs());

        // T2: Translog å†™å…¥
        Translog.Location location = translog.add(
            new Translog.Index(
                index.type(),
                index.id(),
                index.seqNo(),
                index.primaryTerm(),
                index.version(),
                index.source()
            )
        );

        return new IndexResult(version, seqNo, true);
    } catch (Exception e) {
        return new IndexResult(e, version, seqNo);
    }
}
```

---

## ğŸ”„ é˜¶æ®µ 2ï¼šRefresh ä¸ Segment ç”Ÿæˆ (T5-T7)

### 2.1 Refresh è§¦å‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            T5-T7: Refresh ä¸ Segment ç”Ÿæˆ                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ä¸»åˆ†ç‰‡@node-1]                                [S3]
    â”‚
    â”‚ T5: Refresh å®šæ—¶å™¨è§¦å‘ï¼ˆ5ç§’åï¼‰
    â”œâ”€â”€> RefreshTask.run()
    â”‚    â””â”€â”€> IndexShard.refresh()
    â”‚
    â”‚ T6: ç”Ÿæˆæ–° Lucene Segment
    â”œâ”€â”€> InternalEngine.refresh()
    â”‚    â”‚
    â”‚    â”œâ”€> IndexWriter.flush()
    â”‚    â”‚   â””â”€> å°†å†…å­˜ä¸­çš„æ–‡æ¡£å†™å…¥ç£ç›˜
    â”‚    â”‚       ç”Ÿæˆæ®µæ–‡ä»¶ï¼š
    â”‚    â”‚       - _0.cfs  (compound file)
    â”‚    â”‚       - _0.cfe  (compound entries)
    â”‚    â”‚       - _0.si   (segment info)
    â”‚    â”‚       - segments_1  (segment metadata)
    â”‚    â”‚
    â”‚    â””â”€> SearcherManager.maybeRefresh()
    â”‚        â””â”€> æ‰“å¼€æ–°çš„ IndexSearcher
    â”‚            æ–‡æ¡£ç°åœ¨å¯è¢«æœç´¢
    â”‚
    â”‚ T7: ä¸Šä¼  Segment åˆ° S3
    â”œâ”€â”€> RemoteSegmentStoreDirectory.uploadSegments()
    â”‚    â”‚
    â”‚    â”œâ”€> éå†æ–°ç”Ÿæˆçš„æ®µæ–‡ä»¶
    â”‚    â”‚   for (file : ["_0.cfs", "_0.cfe", "_0.si"]) {
    â”‚    â”‚
    â”‚    â”‚   T7.1: ä¸Šä¼ æ–‡ä»¶
    â”‚    â”œâ”€â”€â”€â”€â”€â”€> S3.putObject()                    â”€â”€â”€â”€â”€> [S3]
    â”‚    â”‚        Key: cluster_UUID/index_UUID/           å­˜å‚¨æ®µæ–‡ä»¶
    â”‚    â”‚             shard_0/segments/data/              â””â”€> _0.cfs__uuid123
    â”‚    â”‚             _0.cfs__uuid123                         _0.cfe__uuid456
    â”‚    â”‚                                                      _0.si__uuid789
    â”‚    â”‚   }
    â”‚    â”‚
    â”‚    â”‚   T7.2: ä¸Šä¼ å…ƒæ•°æ®
    â”‚    â””â”€â”€â”€â”€â”€â”€> S3.putObject()                    â”€â”€â”€â”€â”€> [S3]
    â”‚             Key: cluster_UUID/index_UUID/           å­˜å‚¨å…ƒæ•°æ®
    â”‚                  shard_0/segments/metadata/          â””â”€> metadata__1__uuid
    â”‚                  metadata__1__uuid                       {
    â”‚             Content: {                                     "checkpoint": {...},
    â”‚               "checkpoint": {...},                         "files": {...}
    â”‚               "files": {                                 }
    â”‚                 "_0.cfs": {
    â”‚                   "checksum": "abc123",
    â”‚                   "length": 1024
    â”‚                 },
    â”‚                 ...
    â”‚               }
    â”‚             }
```

### 2.2 å…³é”®ä»£ç è·¯å¾„

```java
// server/src/main/java/org/opensearch/index/shard/IndexShard.java:4832

public void refresh(String source) {
    // T6: Lucene refresh
    engine.refresh(source);

    // T7: ä¸Šä¼ åˆ°è¿œç¨‹å­˜å‚¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if (isRemoteStoreEnabled()) {
        syncSegmentsFromLocalStoreToRemoteStore();
    }
}

private void syncSegmentsFromLocalStoreToRemoteStore() throws IOException {
    RemoteSegmentStoreDirectory remoteDirectory =
        (RemoteSegmentStoreDirectory) remoteStore().directory();

    // ä¸Šä¼ æ–°æ®µæ–‡ä»¶
    remoteDirectory.uploadSegments(
        store().getMetadata().asMap(),
        getLatestReplicationCheckpoint()
    );
}
```

```java
// server/src/main/java/org/opensearch/index/store/RemoteSegmentStoreDirectory.java

public void uploadSegments(
    Map<String, StoreFileMetadata> localSegments,
    ReplicationCheckpoint checkpoint
) throws IOException {

    Collection<String> toUpload = diff(localSegments, uploadedSegments);

    // T7.1: å¹¶è¡Œä¸Šä¼ æ®µæ–‡ä»¶
    for (String file : toUpload) {
        String remoteFileName = file + SEGMENT_NAME_UUID_SEPARATOR + UUIDs.randomBase64UUID();

        // ä¸Šä¼ åˆ° S3
        remoteDataDirectory.copyFrom(
            this,
            file,
            remoteFileName,
            IOContext.DEFAULT
        );
    }

    // T7.2: ä¸Šä¼ å…ƒæ•°æ®æ–‡ä»¶
    uploadMetadata(localSegments, checkpoint);
}
```

---

## ğŸ“¡ é˜¶æ®µ 3ï¼šåŒæ­¥å†™å‰¯æœ¬ (T8-T10)

### 3.1 æ£€æŸ¥ç‚¹å‘å¸ƒä¸å¤åˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            T8-T10: å†™å‰¯æœ¬ä»ä¸»åˆ†ç‰‡æ‹‰å– Segment             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ä¸»åˆ†ç‰‡@node-1]                                [å†™å‰¯æœ¬@node-2]
    â”‚
    â”‚ T8: å‘å¸ƒæ£€æŸ¥ç‚¹
    â”œâ”€â”€> CheckpointRefreshListener.afterRefresh()
    â”‚    â”‚
    â”‚    â””â”€â”€> SegmentReplicationCheckpointPublisher.publish()
    â”‚         â”‚
    â”‚         â””â”€â”€> PublishCheckpointAction.publishCheckpoint()
    â”‚              â”‚
    â”‚              â”‚ T8: RPC å‘é€æ£€æŸ¥ç‚¹
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
    â”‚              â”‚ CheckpointInfoRequest {                 â”‚
    â”‚              â”‚   checkpoint: {                          â”‚
    â”‚              â”‚     segmentInfosVersion: 1,              â”‚
    â”‚              â”‚     length: 1024,                        â”‚
    â”‚              â”‚     files: ["_0.cfs", "_0.cfe", "_0.si"] â”‚
    â”‚              â”‚   }                                      â”‚
    â”‚              â”‚ }                                        â”‚
    â”‚              â”‚                                          â”‚
    â”‚              â”‚                                          â”‚ T8.1: æ¥æ”¶æ£€æŸ¥ç‚¹
    â”‚              â”‚                                          â”œâ”€â”€> onNewCheckpoint()
    â”‚              â”‚                                          â”‚
    â”‚              â”‚                                          â”‚ T8.2: åˆ¤æ–­æ˜¯å¦éœ€è¦å¤åˆ¶
    â”‚              â”‚                                          â”œâ”€â”€> shouldProcessCheckpoint()
    â”‚              â”‚                                          â”‚    localCheckpoint.version = 0
    â”‚              â”‚                                          â”‚    receivedCheckpoint.version = 1
    â”‚              â”‚                                          â”‚    éœ€è¦å¤åˆ¶ï¼
    â”‚              â”‚                                          â”‚
    â”‚              â”‚                                          â”‚ T8.3: é€‰æ‹©å¤åˆ¶æº
    â”‚              â”‚                                          â”œâ”€â”€> SegmentReplicationSourceFactory.get()
    â”‚              â”‚                                          â”‚    isSearchOnly() = false
    â”‚              â”‚                                          â”‚    isAssignedOnRemoteNode() = false
    â”‚              â”‚                                          â”‚    â””â”€â”€> PrimaryShardReplicationSource
    â”‚              â”‚                                          â”‚
    â”‚              â”‚                                          â”‚ T9: å¯åŠ¨å¤åˆ¶
    â”‚              â”‚                                          â”œâ”€â”€> SegmentReplicator.startReplication()
    â”‚              â”‚                                          â”‚    â”‚
    â”‚              â”‚                                          â”‚    â””â”€â”€> SegmentReplicationTarget
    â”‚              â”‚                                          â”‚         .startReplication()
    â”‚              â”‚                                          â”‚
    â”‚              â”‚                                          â”‚ T9.1: è·å–å…ƒæ•°æ®
    â”‚              â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”œâ”€â”€> getCheckpointMetadata()
    â”‚              â”‚  RPC: GET_CHECKPOINT_INFO               â”‚
    â”‚              â”‚                                          â”‚
    â”‚ T9.2: è¿”å›å…ƒæ•°æ®                                        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
    â”‚ CheckpointInfoResponse {                               â”‚
    â”‚   metadataMap: {                                       â”‚
    â”‚     "_0.cfs": { checksum: "abc", length: 1024 },      â”‚
    â”‚     "_0.cfe": { checksum: "def", length: 512 },       â”‚
    â”‚     "_0.si": { checksum: "ghi", length: 256 }         â”‚
    â”‚   }                                                    â”‚
    â”‚ }                                                      â”‚
    â”‚                                                        â”‚
    â”‚                                                        â”‚ T9.3: è®¡ç®—å·®å¼‚
    â”‚                                                        â”œâ”€â”€> Store.segmentReplicationDiff()
    â”‚                                                        â”‚    missing: ["_0.cfs", "_0.cfe", "_0.si"]
    â”‚                                                        â”‚    (æœ¬åœ°æ²¡æœ‰ä»»ä½•æ®µ)
    â”‚                                                        â”‚
    â”‚                                                        â”‚ T9.4: è¯·æ±‚æ–‡ä»¶
    â”‚              â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”œâ”€â”€> getSegmentFiles()
    â”‚              â”‚  RPC: GET_SEGMENT_FILES                 â”‚    filesToFetch: ["_0.cfs", "_0.cfe", "_0.si"]
    â”‚              â”‚                                          â”‚
    â”‚ T9.5: å¤„ç†è¯·æ±‚                                          â”‚
    â”œâ”€â”€> SegmentReplicationSourceHandler.sendFiles()         â”‚
    â”‚    â”‚                                                    â”‚
    â”‚    â”œâ”€> åˆ†å—ä¼ è¾“æ–‡ä»¶                                     â”‚
    â”‚    â”‚   FileChunkWriter {                               â”‚
    â”‚    â”‚     concurrent: 8 chunks,                         â”‚
    â”‚    â”‚     chunkSize: 256KB                              â”‚
    â”‚    â”‚   }                                               â”‚
    â”‚    â”‚                                                    â”‚
    â”‚    â”‚   T9.6: ä¼ è¾“æ–‡ä»¶å—                                 â”‚
    â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
    â”‚    â”‚   Chunk 1: _0.cfs [0-256KB]                       â”‚ MultiFileWriter
    â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ å†™å…¥ä¸´æ—¶ç›®å½•
    â”‚    â”‚   Chunk 2: _0.cfs [256KB-512KB]                   â”‚ index/0/index/
    â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ recovery.xxx/
    â”‚    â”‚   ...                                             â”‚
    â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
    â”‚    â”‚   Chunk N: _0.si [complete]                       â”‚
    â”‚                                                        â”‚
    â”‚                                                        â”‚ T10: å®Œæˆå¤åˆ¶
    â”‚                                                        â”œâ”€â”€> finalizeReplication()
    â”‚                                                        â”‚    â”‚
    â”‚                                                        â”‚    â”œâ”€> é‡å‘½åä¸´æ—¶æ–‡ä»¶
    â”‚                                                        â”‚    â”‚   recovery.xxx/_0.cfs â†’ _0.cfs
    â”‚                                                        â”‚    â”‚
    â”‚                                                        â”‚    â”œâ”€> æ›´æ–° SegmentInfos
    â”‚                                                        â”‚    â”‚   segments_1
    â”‚                                                        â”‚    â”‚
    â”‚                                                        â”‚    â””â”€> åˆ·æ–° SearcherManager
    â”‚                                                        â”‚        æ‰“å¼€æ–° IndexSearcher
    â”‚                                                        â”‚
    â”‚                                                        â”‚ âœ… å†™å‰¯æœ¬å¯æœç´¢
```

### 3.2 å…³é”®ä»£ç è·¯å¾„

```java
// server/src/main/java/org/opensearch/indices/replication/checkpoint/PublishCheckpointAction.java

protected void onNewCheckpoint(ReplicationCheckpoint receivedCheckpoint, IndexShard indexShard) {
    // T8.1: æ¥æ”¶æ£€æŸ¥ç‚¹

    // T8.2: åˆ¤æ–­æ˜¯å¦éœ€è¦å¤åˆ¶
    if (shouldProcessCheckpoint(receivedCheckpoint, indexShard)) {
        // T9: å¯åŠ¨å¤åˆ¶
        targetService.startReplication(indexShard, receivedCheckpoint, ...);
    }
}
```

```java
// server/src/main/java/org/opensearch/indices/replication/SegmentReplicationTarget.java

@Override
public void startReplication(ActionListener<Void> listener) {
    // T9.1: è·å–å…ƒæ•°æ®
    getCheckpointMetadata(ActionListener.wrap(
        checkpointInfo -> {
            // T9.3: è®¡ç®—å·®å¼‚ & T9.4: è¯·æ±‚æ–‡ä»¶
            getFiles(checkpointInfo, ActionListener.wrap(
                v -> {
                    // T10: å®Œæˆå¤åˆ¶
                    finalizeReplication(checkpointInfo);
                    listener.onResponse(null);
                },
                listener::onFailure
            ));
        },
        listener::onFailure
    ));
}
```

---

## ğŸ” é˜¶æ®µ 4ï¼šæœç´¢å‰¯æœ¬ä»è¿œç¨‹æ‹‰å– (T11-T13)

### 4.1 å¹¶è¡Œå¤åˆ¶æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        T11-T13: æœç´¢å‰¯æœ¬ä» S3 æ‹‰å– Segment                â”‚
â”‚        ï¼ˆä¸å†™å‰¯æœ¬å¤åˆ¶å¹¶è¡Œè¿›è¡Œï¼‰                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ä¸»åˆ†ç‰‡@node-1]        [S3]              [æœç´¢å‰¯æœ¬#1@node-3]     [æœç´¢å‰¯æœ¬#2@node-4]
    â”‚
    â”‚ T11: å‘å¸ƒæ£€æŸ¥ç‚¹åˆ°æœç´¢å‰¯æœ¬
    â”œâ”€â”€> PublishCheckpointAction.publishCheckpoint()
    â”‚    â”‚
    â”‚    â”‚ T11: å¹¿æ’­åˆ°æ‰€æœ‰å‰¯æœ¬ï¼ˆåŒ…æ‹¬æœç´¢å‰¯æœ¬ï¼‰
    â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                      â”‚
    â”‚    â”‚ CheckpointInfoRequest {                     â”‚                      â”‚
    â”‚    â”‚   checkpoint: {                              â”‚                      â”‚
    â”‚    â”‚     segmentInfosVersion: 1                   â”‚                      â”‚
    â”‚    â”‚   }                                          â”‚                      â”‚
    â”‚    â”‚ }                                            â”‚                      â”‚
    â”‚    â”‚                                              â”‚                      â”‚
    â”‚    â”‚                                              â”‚ T11.1: æ¥æ”¶æ£€æŸ¥ç‚¹     â”‚
    â”‚    â”‚                                              â”œâ”€â”€> onNewCheckpoint()  â”‚
    â”‚    â”‚                                              â”‚                      â”‚
    â”‚    â”‚                                              â”‚ T11.2: åˆ¤æ–­åˆ†ç‰‡ç±»å‹   â”‚
    â”‚    â”‚                                              â”œâ”€â”€> isSearchOnly()     â”‚
    â”‚    â”‚                                              â”‚    = true             â”‚
    â”‚    â”‚                                              â”‚                      â”‚
    â”‚    â”‚                                              â”‚ T11.3: é€‰æ‹©å¤åˆ¶æº     â”‚
    â”‚    â”‚                                              â”œâ”€â”€> SegmentReplication â”‚
    â”‚    â”‚                                              â”‚    SourceFactory.get()â”‚
    â”‚    â”‚                                              â”‚    isAssignedOnRemote â”‚
    â”‚    â”‚                                              â”‚    Node() = true      â”‚
    â”‚    â”‚                                              â”‚    â””â”€â”€> RemoteStore   â”‚
    â”‚    â”‚                                              â”‚         Replication   â”‚
    â”‚    â”‚                                              â”‚         Source        â”‚
    â”‚    â”‚                                              â”‚                      â”‚
    â”‚    â”‚                                              â”‚ T12: å¯åŠ¨å¤åˆ¶        â”‚
    â”‚    â”‚                                              â”œâ”€â”€> startReplication() â”‚
    â”‚    â”‚                                              â”‚                      â”‚
    â”‚    â”‚                                              â”‚ T12.1: è·å–è¿œç¨‹å…ƒæ•°æ® â”‚
    â”‚    â”‚                                              â”œâ”€â”€> getCheckpoint     â”‚
    â”‚    â”‚         S3.getObject()                       â”‚    Metadata()        â”‚
    â”‚    â”‚         <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”‚    â”‚                 â”‚
    â”‚    â”‚         Key: metadata__1__uuid               â”‚    â”‚                 â”‚
    â”‚         è¿”å›å…ƒæ•°æ®                                 â”‚    â”‚                 â”‚
    â”‚         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                    â”‚    â”‚                 â”‚
    â”‚         {                                         â”‚    â”‚                 â”‚
    â”‚           "files": {                              â”‚    â”‚                 â”‚
    â”‚             "_0.cfs__uuid123": {...},            â”‚    â”‚                 â”‚
    â”‚             "_0.cfe__uuid456": {...},            â”‚    â”‚                 â”‚
    â”‚             "_0.si__uuid789": {...}              â”‚    â”‚                 â”‚
    â”‚           }                                       â”‚    â”‚                 â”‚
    â”‚         }                                         â”‚    â–¼                 â”‚
    â”‚                                                   â”‚ T12.2: è§£æå…ƒæ•°æ®     â”‚
    â”‚                                                   â”œâ”€â”€> æ˜ å°„è¿œç¨‹æ–‡ä»¶å     â”‚
    â”‚                                                   â”‚    _0.cfs__uuid123   â”‚
    â”‚                                                   â”‚      â†’ _0.cfs        â”‚
    â”‚                                                   â”‚                      â”‚
    â”‚                                                   â”‚ T12.3: å‡†å¤‡ä¸‹è½½      â”‚
    â”‚                                                   â”œâ”€â”€> filesToFetch:     â”‚
    â”‚                                                   â”‚    ["_0.cfs",        â”‚
    â”‚                                                   â”‚     "_0.cfe",        â”‚
    â”‚                                                   â”‚     "_0.si"]         â”‚
    â”‚                                                   â”‚                      â”‚
    â”‚                                                   â”‚ T12.4: å¯åŠ¨å¹¶è¡Œä¸‹è½½   â”‚
    â”‚                                                   â”œâ”€â”€> RemoteStoreFile   â”‚
    â”‚                                                   â”‚    Downloader        â”‚
    â”‚                                                   â”‚    .downloadAsync()  â”‚
    â”‚                                                   â”‚    threads = 4       â”‚
    â”‚                                                   â”‚                      â”‚
    â”‚         T12.5: å¹¶å‘ä¸‹è½½æ–‡ä»¶                         â”‚                      â”‚
    â”‚         S3.getObject() [çº¿ç¨‹1]                     â”‚                      â”‚
    â”‚         <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”œâ”€â”€> ä¸‹è½½ _0.cfs       â”‚
    â”‚         Key: _0.cfs__uuid123                      â”‚                      â”‚
    â”‚         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                    â”‚                      â”‚
    â”‚         [æ–‡ä»¶å†…å®¹æµ]                               â”‚    å†™å…¥æœ¬åœ°å­˜å‚¨       â”‚
    â”‚                                                   â”‚                      â”‚
    â”‚         S3.getObject() [çº¿ç¨‹2]                     â”‚                      â”‚
    â”‚         <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”œâ”€â”€> ä¸‹è½½ _0.cfe       â”‚
    â”‚         Key: _0.cfe__uuid456                      â”‚                      â”‚
    â”‚         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                    â”‚                      â”‚
    â”‚         [æ–‡ä»¶å†…å®¹æµ]                               â”‚                      â”‚
    â”‚                                                   â”‚                      â”‚
    â”‚         S3.getObject() [çº¿ç¨‹3]                     â”‚                      â”‚
    â”‚         <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”œâ”€â”€> ä¸‹è½½ _0.si        â”‚
    â”‚         Key: _0.si__uuid789                       â”‚                      â”‚
    â”‚         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                    â”‚                      â”‚
    â”‚         [æ–‡ä»¶å†…å®¹æµ]                               â”‚                      â”‚
    â”‚                                                   â”‚                      â”‚
    â”‚                                                   â”‚ T13: å®Œæˆä¸‹è½½        â”‚
    â”‚                                                   â”œâ”€â”€> æ‰€æœ‰æ–‡ä»¶ä¸‹è½½å®Œæˆ   â”‚
    â”‚                                                   â”‚                      â”‚
    â”‚                                                   â”‚ T13.1: å®Œæˆå¤åˆ¶      â”‚
    â”‚                                                   â”œâ”€â”€> finalizeReplication()
    â”‚                                                   â”‚    â”‚                 â”‚
    â”‚                                                   â”‚    â”œâ”€> æ›´æ–°SegmentInfos
    â”‚                                                   â”‚    â”‚                 â”‚
    â”‚                                                   â”‚    â””â”€> åˆ·æ–°Searcher  â”‚
    â”‚                                                   â”‚                      â”‚
    â”‚                                                   â”‚ âœ… æœç´¢å‰¯æœ¬#1å¯æœç´¢   â”‚
    â”‚                                                   â”‚                      â”‚
    â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
    â”‚    â”‚ ï¼ˆåŒæ ·çš„æµç¨‹åœ¨æœç´¢å‰¯æœ¬#2å¹¶è¡Œæ‰§è¡Œï¼‰                                        â”‚
    â”‚    â”‚                                                                      â”‚
    â”‚                                                                           â”‚ âœ… æœç´¢å‰¯æœ¬#2å¯æœç´¢
```

### 4.2 å…³é”®ä»£ç è·¯å¾„

```java
// server/src/main/java/org/opensearch/indices/replication/RemoteStoreReplicationSource.java:164

@Override
public void getSegmentFiles(
    long replicationId,
    ReplicationCheckpoint checkpoint,
    List<StoreFileMetadata> filesToFetch,
    IndexShard indexShard,
    BiConsumer<String, Long> fileProgressTracker,
    ActionListener<GetSegmentFilesResponse> listener
) {
    // T12.3: å‡†å¤‡ä¸‹è½½æ–‡ä»¶åˆ—è¡¨
    final List<String> toDownloadSegmentNames = filesToFetch.stream()
        .map(StoreFileMetadata::name)
        .toList();

    // T12.4: å¯åŠ¨å¹¶è¡Œä¸‹è½½
    indexShard.getFileDownloader()
        .downloadAsync(
            cancellableThreads,
            remoteDirectory,              // S3 è¿œç¨‹ç›®å½•
            storeDirectory,                // æœ¬åœ°å­˜å‚¨ç›®å½•
            toDownloadSegmentNames,
            ActionListener.map(listener, r -> new GetSegmentFilesResponse(filesToFetch))
        );
}
```

```java
// server/src/main/java/org/opensearch/index/store/RemoteStoreFileDownloader.java:87

public void downloadAsync(
    CancellableThreads cancellableThreads,
    Directory source,
    Directory destination,
    Collection<String> toDownloadSegments,
    ActionListener<Void> listener
) {
    final Queue<String> queue = new ConcurrentLinkedQueue<>(toDownloadSegments);

    // T12.4: è®¡ç®—å¹¶å‘çº¿ç¨‹æ•°
    final int threads = Math.min(
        toDownloadSegments.size(),
        Math.min(
            threadPool.info(ThreadPool.Names.REMOTE_RECOVERY).getMax(),
            recoverySettings.getMaxConcurrentRemoteStoreStreams()  // é»˜è®¤ 4
        )
    );

    // T12.5: å¯åŠ¨å¤šä¸ªä¸‹è½½çº¿ç¨‹
    for (int i = 0; i < threads; i++) {
        copyOneFile(cancellableThreads, source, destination, queue, listener);
    }
}

private void copyOneFile(...) {
    final String file = queue.poll();
    if (file != null) {
        threadPool.executor(ThreadPool.Names.REMOTE_RECOVERY).submit(() -> {
            // T12.5: ç›´æ¥ä»è¿œç¨‹ç›®å½•å¤åˆ¶åˆ°æœ¬åœ°
            destination.copyFrom(source, file, file, IOContext.DEFAULT);

            // é€’å½’å¤„ç†ä¸‹ä¸€ä¸ªæ–‡ä»¶
            copyOneFile(...);
        });
    }
}
```

---

## ğŸ” é˜¶æ®µ 5ï¼šæŸ¥è¯¢æ‰§è¡Œ (T14-T17)

### 5.1 æŸ¥è¯¢æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              T14-T17: æŸ¥è¯¢æ‰§è¡Œæµç¨‹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[å®¢æˆ·ç«¯]        [åè°ƒèŠ‚ç‚¹]       [æœç´¢å‰¯æœ¬#1@node-3]      [æœç´¢å‰¯æœ¬#2@node-4]
    â”‚
    â”‚ T14: å‘èµ·æœç´¢è¯·æ±‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
    â”‚ GET /products/_search
    â”‚ {
    â”‚   "query": {
    â”‚     "match": {
    â”‚       "name": "Laptop"
    â”‚     }
    â”‚   }
    â”‚ }
    â”‚              â”‚
    â”‚              â”‚ T15: è·¯ç”±å†³ç­–
    â”‚              â”œâ”€â”€> è·å–åˆ†ç‰‡ä¿¡æ¯
    â”‚              â”‚    [products][0] æœ‰ 4 ä¸ªå‰¯æœ¬:
    â”‚              â”‚    - Primary @ node-1
    â”‚              â”‚    - Write Replica @ node-2
    â”‚              â”‚    - Search Replica #1 @ node-3  â† é€‰ä¸­
    â”‚              â”‚    - Search Replica #2 @ node-4
    â”‚              â”‚
    â”‚              â”‚ T15.1: é€‰æ‹©æœç´¢å‰¯æœ¬
    â”‚              â”‚    ç­–ç•¥: è½®è¯¢ (Round-robin)
    â”‚              â”‚    æˆ–: è‡ªé€‚åº”è·¯ç”± (Adaptive)
    â”‚              â”‚
    â”‚              â”‚ T15.2: åˆ†å‘æŸ¥è¯¢
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
    â”‚              â”‚ SearchRequest {                  â”‚
    â”‚              â”‚   shardId: [products][0],        â”‚
    â”‚              â”‚   query: match(name, "Laptop")   â”‚
    â”‚              â”‚ }                                â”‚
    â”‚              â”‚                                  â”‚
    â”‚              â”‚                                  â”‚ T16: æ‰§è¡ŒæŸ¥è¯¢
    â”‚              â”‚                                  â”œâ”€â”€> IndexShard.search()
    â”‚              â”‚                                  â”‚    â”‚
    â”‚              â”‚                                  â”‚    â”œâ”€> Engine.searcher()
    â”‚              â”‚                                  â”‚    â”‚   è·å– IndexSearcher
    â”‚              â”‚                                  â”‚    â”‚
    â”‚              â”‚                                  â”‚    â”œâ”€> Query é‡å†™
    â”‚              â”‚                                  â”‚    â”‚   match â†’ TermQuery
    â”‚              â”‚                                  â”‚    â”‚
    â”‚              â”‚                                  â”‚    â”œâ”€> Lucene æœç´¢
    â”‚              â”‚                                  â”‚    â”‚   IndexSearcher.search()
    â”‚              â”‚                                  â”‚    â”‚   â”‚
    â”‚              â”‚                                  â”‚    â”‚   â”œâ”€> è¯»å–å€’æ’ç´¢å¼•
    â”‚              â”‚                                  â”‚    â”‚   â”‚   term: "laptop" â†’ [doc1]
    â”‚              â”‚                                  â”‚    â”‚   â”‚
    â”‚              â”‚                                  â”‚    â”‚   â”œâ”€> è®¡ç®—ç›¸å…³æ€§å¾—åˆ†
    â”‚              â”‚                                  â”‚    â”‚   â”‚   TF-IDF / BM25
    â”‚              â”‚                                  â”‚    â”‚   â”‚
    â”‚              â”‚                                  â”‚    â”‚   â””â”€> æ”¶é›†ç»“æœ
    â”‚              â”‚                                  â”‚    â”‚       TopDocs
    â”‚              â”‚                                  â”‚    â”‚
    â”‚              â”‚                                  â”‚    â””â”€> åŠ è½½æ–‡æ¡£å­—æ®µ
    â”‚              â”‚                                  â”‚        _source, _id, _score
    â”‚              â”‚                                  â”‚
    â”‚              â”‚  T17: è¿”å›ç»“æœ                    â”‚
    â”‚              â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”¤
    â”‚              â”‚  SearchResponse {                â”‚
    â”‚              â”‚    hits: [                       â”‚
    â”‚              â”‚      {                           â”‚
    â”‚              â”‚        _id: "1",                 â”‚
    â”‚              â”‚        _score: 1.23,             â”‚
    â”‚              â”‚        _source: {                â”‚
    â”‚              â”‚          name: "Laptop",         â”‚
    â”‚              â”‚          price: 999.99,          â”‚
    â”‚              â”‚          category: "Electronics" â”‚
    â”‚              â”‚        }                         â”‚
    â”‚              â”‚      }                           â”‚
    â”‚              â”‚    ]                             â”‚
    â”‚              â”‚  }                               â”‚
    â”‚              â”‚                                  â”‚
    â”‚  T17: è¿”å›ç»“æœâ”‚                                  â”‚
    â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                  â”‚
    â”‚  {            â”‚                                  â”‚
    â”‚    hits: [...]
    â”‚  }
```

### 5.2 å…³é”®ä»£ç è·¯å¾„

```java
// server/src/main/java/org/opensearch/action/search/SearchTransportService.java

public void sendExecuteQuery(
    Transport.Connection connection,
    final ShardSearchRequest request,
    SearchTask task,
    final SearchActionListener<SearchPhaseResult> listener
) {
    // T15.2: å‘é€æŸ¥è¯¢åˆ°åˆ†ç‰‡
    transportService.sendChildRequest(
        connection,
        QUERY_ACTION_NAME,
        request,
        task,
        new ConnectionCountingHandler<>(listener, connection)
    );
}
```

```java
// server/src/main/java/org/opensearch/search/SearchService.java

public void executeQueryPhase(
    ShardSearchRequest request,
    SearchShardTask task,
    ActionListener<SearchPhaseResult> listener
) {
    // T16: æ‰§è¡ŒæŸ¥è¯¢
    try (SearchContext searchContext = createContext(request)) {
        // è·å– Lucene Searcher
        Engine.Searcher searcher = searchContext.searcher();

        // æ‰§è¡ŒæŸ¥è¯¢
        queryPhase.execute(searchContext);

        // è¿”å›ç»“æœ
        listener.onResponse(searchContext.queryResult());
    }
}
```

---

## ğŸ“Š å®Œæ•´æ—¶åºå›¾ï¼ˆæ–‡æœ¬ç‰ˆï¼‰

```
æ—¶é—´è½´                ä¸»åˆ†ç‰‡@node-1              å†™å‰¯æœ¬@node-2         æœç´¢å‰¯æœ¬#1@node-3       S3
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T0   å®¢æˆ·ç«¯POSTè¯·æ±‚   â”€â”€â”€>
T1                   å†™å…¥å†…å­˜
T2                   å†™å…¥translog
T3   <â”€â”€â”€ è¿”å›æˆåŠŸ

T4-T5               (ç­‰å¾…5ç§’ refresh_interval)

T5                   è§¦å‘Refresh
T6                   ç”ŸæˆSegment
                     - _0.cfs
                     - _0.cfe
                     - _0.si
T7                   ä¸Šä¼ Segment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> å­˜å‚¨æ®µæ–‡ä»¶

T8                   å‘å¸ƒæ£€æŸ¥ç‚¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æ¥æ”¶æ£€æŸ¥ç‚¹
                                                åˆ¤æ–­éœ€è¦å¤åˆ¶
                                                é€‰æ‹©å¤åˆ¶æº:
                                                PrimaryShardReplication
                                                Source

T9                                              å¯åŠ¨å¤åˆ¶
                     <â”€â”€â”€â”€ è¯·æ±‚å…ƒæ•°æ®
                     è¿”å›å…ƒæ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                     <â”€â”€â”€â”€ è¯·æ±‚æ–‡ä»¶
T9.5                 åˆ†å—ä¼ è¾“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>   æ¥æ”¶æ–‡ä»¶å—
                                                å†™å…¥ä¸´æ—¶ç›®å½•

T10                                             å®Œæˆå¤åˆ¶
                                                é‡å‘½åæ–‡ä»¶
                                                âœ… å¯æœç´¢

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                     (å¹¶è¡Œè·¯å¾„: æœç´¢å‰¯æœ¬)

T11                  å‘å¸ƒæ£€æŸ¥ç‚¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æ¥æ”¶æ£€æŸ¥ç‚¹
                                                                          åˆ¤æ–­éœ€è¦å¤åˆ¶
                                                                          é€‰æ‹©å¤åˆ¶æº:
                                                                          RemoteStoreReplication
                                                                          Source

T12                                                                       è·å–å…ƒæ•°æ®
                                                                 <â”€â”€â”€â”€â”€â”€â”€ è¯·æ±‚å…ƒæ•°æ® â”€â”€â”€â”€â”€ S3
                                                                 â”€â”€â”€â”€â”€â”€> è¿”å›å…ƒæ•°æ®

T12.5                                                                     å¹¶è¡Œä¸‹è½½ (4çº¿ç¨‹)
                                                                 <â”€â”€â”€â”€â”€â”€â”€ ä¸‹è½½_0.cfs â”€â”€â”€â”€â”€ S3
                                                                 <â”€â”€â”€â”€â”€â”€â”€ ä¸‹è½½_0.cfe â”€â”€â”€â”€â”€ S3
                                                                 <â”€â”€â”€â”€â”€â”€â”€ ä¸‹è½½_0.si â”€â”€â”€â”€â”€â”€ S3

T13                                                                       å®Œæˆå¤åˆ¶
                                                                          âœ… å¯æœç´¢

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                     (æŸ¥è¯¢é˜¶æ®µ)

T14  å®¢æˆ·ç«¯GETè¯·æ±‚ â”€â”€â”€> åè°ƒèŠ‚ç‚¹è·¯ç”±
T15                                              (è·³è¿‡)                    <â”€â”€â”€ é€‰ä¸­æ‰§è¡ŒæŸ¥è¯¢
T16                                                                       æ‰§è¡ŒLuceneæœç´¢
                                                                          è¯»å–å€’æ’ç´¢å¼•
                                                                          è®¡ç®—å¾—åˆ†
T17  <â”€â”€â”€ è¿”å›ç»“æœ <â”€â”€â”€ èšåˆç»“æœ                                           è¿”å›ç»“æœ â”€â”€â”€â”€>

```

---

## ğŸ”§ é…ç½®æ–‡ä»¶å®Œæ•´ç¤ºä¾‹

### opensearch.yml

```yaml
# é›†ç¾¤é…ç½®
cluster.name: my-opensearch-cluster
cluster.remote_store.enabled: true

# èŠ‚ç‚¹é…ç½® (node-1: ä¸»åˆ†ç‰‡èŠ‚ç‚¹)
node.name: node-1
node.roles: [master, data]

# è¿œç¨‹å­˜å‚¨é…ç½®
s3.client.default.endpoint: s3.amazonaws.com
s3.client.default.region: us-east-1

# æ®µå¤åˆ¶é…ç½®
indices.recovery.max_concurrent_file_chunks: 8
indices.recovery.chunk_size: 256kb
indices.recovery.max_bytes_per_sec: 75mb

# è¿œç¨‹å­˜å‚¨ä¸‹è½½é…ç½®
indices.recovery.max_concurrent_remote_store_streams: 4
thread_pool.remote_recovery.size: 10

# æœç´¢é…ç½®
search.max_buckets: 65536
```

### åˆ›å»ºè¿œç¨‹å­˜å‚¨ä»“åº“

```json
PUT /_snapshot/s3-repo
{
  "type": "s3",
  "settings": {
    "bucket": "opensearch-remote-store",
    "region": "us-east-1",
    "base_path": "segments",
    "compress": true
  }
}
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡ç¤ºä¾‹

### å†™å…¥æ€§èƒ½

```
å†™å…¥å»¶è¿Ÿ:
  - P50: 5ms   (T0-T3: å†™å…¥ä¸»åˆ†ç‰‡)
  - P95: 15ms
  - P99: 30ms

å‰¯æœ¬åŒæ­¥å»¶è¿Ÿ:
  - å†™å‰¯æœ¬: 5-10ç§’  (å–å†³äº refresh_interval)
  - æœç´¢å‰¯æœ¬: 5-15ç§’ (refresh + S3ä¸‹è½½)
```

### æŸ¥è¯¢æ€§èƒ½

```
æŸ¥è¯¢å»¶è¿Ÿ:
  - ä¸»åˆ†ç‰‡: 10-20ms
  - å†™å‰¯æœ¬: 10-20ms
  - æœç´¢å‰¯æœ¬: 10-20ms (ç›¸åŒæ€§èƒ½ï¼)

æœç´¢å‰¯æœ¬ä¼˜åŠ¿:
  âœ… ä¸å—å†™å…¥å½±å“
  âœ… ç‹¬ç«‹æ‰©å±•
  âœ… ä¸“ç”¨äºæœç´¢ä¼˜åŒ–
```

### ç½‘ç»œå¼€é”€

```
å†™å…¥1ä¸ªæ–‡æ¡£åçš„ç½‘ç»œä¼ è¾“:

ä¼ ç»Ÿæ¨¡å¼ (æ— è¿œç¨‹å­˜å‚¨):
  - ä¸»åˆ†ç‰‡ â†’ å†™å‰¯æœ¬: 1KB Ã— 1 = 1KB

è¿œç¨‹å­˜å‚¨æ¨¡å¼:
  - ä¸»åˆ†ç‰‡ â†’ S3: å‡è®¾segment 100KB
  - S3 â†’ æœç´¢å‰¯æœ¬ #1: 100KB
  - S3 â†’ æœç´¢å‰¯æœ¬ #2: 100KB

  ä¸»åˆ†ç‰‡å‡ºå£æµé‡: 100KB
  å‰¯æœ¬å…¥å£æµé‡: 200KB (å¹¶è¡Œ,ä¸ç»è¿‡ä¸»åˆ†ç‰‡)

å¯¹æ¯”ä¼ ç»Ÿæ¨¡å¼(ä¸»åˆ†ç‰‡ â†’ 2ä¸ªå‰¯æœ¬):
  ä¸»åˆ†ç‰‡å‡ºå£æµé‡: 200KB

ç»“è®º: è¿œç¨‹å­˜å‚¨å‡å°‘äº†ä¸»åˆ†ç‰‡çš„ç½‘ç»œè´Ÿè½½ 50%
```

---

## ğŸ¯ å…³é”®è§‚å¯Ÿç‚¹

### 1. æ•°æ®å¯è§æ€§æ—¶é—´çº¿

```
å†™å…¥å®Œæˆ(T3)            ä¸»åˆ†ç‰‡å¯æœç´¢(T6)         å†™å‰¯æœ¬å¯æœç´¢(T10)     æœç´¢å‰¯æœ¬å¯æœç´¢(T13)
    â”‚                       â”‚                      â”‚                     â”‚
    0ms                    5s                     6-7s                  6-8s
    â”‚                       â”‚                      â”‚                     â”‚
    â””â”€ å†™å…¥å†…å­˜+translog     â””â”€ Refreshç”Ÿæˆsegment  â””â”€ ä»ä¸»åˆ†ç‰‡æ‹‰å–       â””â”€ ä»S3æ‹‰å–
       è¿”å›æˆåŠŸ                 æ‰“å¼€æ–°searcher        å®Œæˆå¤åˆ¶             å®Œæˆå¤åˆ¶
```

### 2. å¤åˆ¶æºé€‰æ‹©å·®å¼‚

```
å†™å‰¯æœ¬ (isSearchOnly = false):
  â”œâ”€ å¦‚æœ isAssignedOnRemoteNode = true
  â”‚   â””â”€> RemoteStoreReplicationSource (ä»S3)
  â””â”€ å¦‚æœ isAssignedOnRemoteNode = false
      â””â”€> PrimaryShardReplicationSource (ä»ä¸»åˆ†ç‰‡)

æœç´¢å‰¯æœ¬ (isSearchOnly = true):
  â””â”€> å¼ºåˆ¶ RemoteStoreReplicationSource (ä»S3)
```

### 3. å¹¶å‘ä¸‹è½½ä¼˜åŠ¿

```
æœç´¢å‰¯æœ¬ä»S3ä¸‹è½½:
  - 4ä¸ªå¹¶å‘æµ
  - æ¯ä¸ªæµç‹¬ç«‹ä¸‹è½½ä¸€ä¸ªæ–‡ä»¶
  - å……åˆ†åˆ©ç”¨S3çš„å¹¶å‘èƒ½åŠ›
  - ä¸å ç”¨ä¸»åˆ†ç‰‡çš„ç½‘ç»œ/CPUèµ„æº

å†™å‰¯æœ¬ä»ä¸»åˆ†ç‰‡ä¸‹è½½:
  - 8ä¸ªå¹¶å‘å—
  - åˆ†å—ä¼ è¾“åŒä¸€ä¸ªæ–‡ä»¶
  - å—é™äºä¸»åˆ†ç‰‡çš„ç½‘ç»œå¸¦å®½
  - ä¸»åˆ†ç‰‡éœ€è¦å¤„ç†å¤šä¸ªå‰¯æœ¬çš„è¯·æ±‚
```

---

## ğŸš€ ä¼˜åŒ–å»ºè®®

### 1. é’ˆå¯¹å†™å¯†é›†å‹åœºæ™¯

```yaml
# å¢åŠ  refresh é—´éš”ï¼Œå‡å°‘æ®µç”Ÿæˆé¢‘ç‡
index.refresh_interval: 30s

# å‡å°‘å‰¯æœ¬æ•°é‡
index.number_of_replicas: 1
index.number_of_search_replicas: 0
```

### 2. é’ˆå¯¹è¯»å¯†é›†å‹åœºæ™¯

```yaml
# å¢åŠ æœç´¢å‰¯æœ¬
index.number_of_replicas: 1          # ä»…ä¿ç•™1ä¸ªå†™å‰¯æœ¬ç”¨äºå®¹ç¾
index.number_of_search_replicas: 5   # å¢åŠ æœç´¢å‰¯æœ¬æ‰©å±•è¯»èƒ½åŠ›

# ä¼˜åŒ–è¿œç¨‹å­˜å‚¨ä¸‹è½½
indices.recovery.max_concurrent_remote_store_streams: 8
thread_pool.remote_recovery.size: 20
```

### 3. é’ˆå¯¹æ··åˆåœºæ™¯

```yaml
# å¹³è¡¡ refresh é—´éš”
index.refresh_interval: 5s

# æ··åˆå‰¯æœ¬é…ç½®
index.number_of_replicas: 1
index.number_of_search_replicas: 2

# å¯ç”¨è‡ªé€‚åº”å‰¯æœ¬é€‰æ‹©
cluster.routing.allocation.awareness.enabled: true
```

---

## ğŸ“š ç›¸å…³æºæ–‡ä»¶

### å†™å…¥è·¯å¾„
- `server/src/main/java/org/opensearch/index/shard/IndexShard.java`
- `server/src/main/java/org/opensearch/index/engine/InternalEngine.java`
- `server/src/main/java/org/opensearch/index/translog/Translog.java`

### Refresh ä¸ä¸Šä¼ 
- `server/src/main/java/org/opensearch/index/shard/IndexShard.java:4832`
- `server/src/main/java/org/opensearch/index/store/RemoteSegmentStoreDirectory.java`

### æ£€æŸ¥ç‚¹å‘å¸ƒ
- `server/src/main/java/org/opensearch/indices/replication/checkpoint/PublishCheckpointAction.java`
- `server/src/main/java/org/opensearch/indices/replication/checkpoint/SegmentReplicationCheckpointPublisher.java`

### å†™å‰¯æœ¬å¤åˆ¶
- `server/src/main/java/org/opensearch/indices/replication/PrimaryShardReplicationSource.java`
- `server/src/main/java/org/opensearch/indices/replication/SegmentReplicationSourceHandler.java`

### æœç´¢å‰¯æœ¬å¤åˆ¶
- `server/src/main/java/org/opensearch/indices/replication/RemoteStoreReplicationSource.java`
- `server/src/main/java/org/opensearch/index/store/RemoteStoreFileDownloader.java`

### æŸ¥è¯¢æ‰§è¡Œ
- `server/src/main/java/org/opensearch/search/SearchService.java`
- `server/src/main/java/org/opensearch/action/search/SearchTransportService.java`

---

## ğŸ“ æ€»ç»“

è¿™ä¸ªå®Œæ•´ç¤ºä¾‹å±•ç¤ºäº†ï¼š

1. **å†™å…¥è·¯å¾„** (T0-T7)
   - æ–‡æ¡£å†™å…¥ä¸»åˆ†ç‰‡å†…å­˜å’Œ translog
   - Refresh ç”Ÿæˆ Lucene segment
   - ä¸Šä¼  segment åˆ° S3

2. **å†™å‰¯æœ¬åŒæ­¥** (T8-T10)
   - ä¸»åˆ†ç‰‡å‘å¸ƒæ£€æŸ¥ç‚¹
   - å†™å‰¯æœ¬é€šè¿‡ RPC ä»ä¸»åˆ†ç‰‡æ‹‰å– segment
   - åˆ†å—ä¼ è¾“å¹¶å®Œæˆå¤åˆ¶

3. **æœç´¢å‰¯æœ¬åŒæ­¥** (T11-T13)
   - ä¸»åˆ†ç‰‡å‘å¸ƒæ£€æŸ¥ç‚¹
   - æœç´¢å‰¯æœ¬ä» S3 å¹¶è¡Œä¸‹è½½ segment
   - ä¸ä¾èµ–ä¸»åˆ†ç‰‡ï¼Œå®Œå…¨è§£è€¦

4. **æŸ¥è¯¢æ‰§è¡Œ** (T14-T17)
   - åè°ƒèŠ‚ç‚¹è·¯ç”±åˆ°æœç´¢å‰¯æœ¬
   - æœç´¢å‰¯æœ¬æ‰§è¡Œ Lucene æŸ¥è¯¢
   - è¿”å›ç»“æœ

**å…³é”®ä¼˜åŠ¿**ï¼š
- âœ… è¯»å†™åˆ†ç¦»ï¼šæœç´¢å‰¯æœ¬ä¸“æ³¨æŸ¥è¯¢
- âœ… ç‹¬ç«‹æ‰©å±•ï¼šå¢åŠ æœç´¢å‰¯æœ¬ä¸å¢åŠ ä¸»åˆ†ç‰‡è´Ÿè½½
- âœ… é«˜å¯ç”¨ï¼šå¤šä¸ªæ•°æ®æºï¼ˆä¸»åˆ†ç‰‡ã€å†™å‰¯æœ¬ã€S3ï¼‰

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2025-10-22
**OpenSearch ç‰ˆæœ¬**: 3.3.x