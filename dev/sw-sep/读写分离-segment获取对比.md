# è¯»å†™åˆ†ç¦»æ¶æ„ä¸­çš„ Segment è·å–æ–¹å¼å¯¹æ¯”

> æœ¬æ–‡æ¡£è¯¦ç»†å¯¹æ¯” OpenSearch è¯»å†™åˆ†ç¦»æ¶æ„ä¸­ï¼Œä¸åŒç±»å‹åˆ†ç‰‡è·å– Segment çš„æ–¹å¼

---

## ğŸ“Š æ ¸å¿ƒç­”æ¡ˆ

**æ˜¯çš„ï¼Œè¯»åˆ†ç‰‡ï¼ˆSearch-only Replicasï¼‰ä¹Ÿæ˜¯ä»è¿œç¨‹æ‹‰å– segmentï¼Œä½†æ–¹å¼ä¸å†™å‰¯æœ¬ä¸åŒï¼**

---

## ğŸ” ä¸€ã€åˆ†ç‰‡ç±»å‹åˆ†ç±»

åœ¨ OpenSearch è¯»å†™åˆ†ç¦»æ¶æ„ä¸­ï¼Œå­˜åœ¨ä¸‰ç§åˆ†ç‰‡ç±»å‹ï¼š

```
æ‰€æœ‰åˆ†ç‰‡
    â”‚
    â”œâ”€ ä¸»åˆ†ç‰‡ (Primary Shard)
    â”‚   â”œâ”€ å¤„ç†å†™å…¥è¯·æ±‚
    â”‚   â”œâ”€ ç”Ÿæˆæ®µæ–‡ä»¶
    â”‚   â”œâ”€ ä¸Šä¼ æ®µåˆ°è¿œç¨‹å­˜å‚¨ï¼ˆå¦‚å¯ç”¨ï¼‰
    â”‚   â””â”€ å‘å¸ƒæ£€æŸ¥ç‚¹
    â”‚
    â”œâ”€ å†™å‰¯æœ¬ (Write Replica)
    â”‚   â”œâ”€ å‚ä¸æ®µå¤åˆ¶
    â”‚   â”œâ”€ å¯å¤„ç†æœç´¢è¯·æ±‚
    â”‚   â”œâ”€ å¯ä»¥ä¸Šä¼ æ®µåˆ°è¿œç¨‹å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
    â”‚   â””â”€ å¤åˆ¶æºé€‰æ‹©ï¼š
    â”‚       â”œâ”€ ä¸»åˆ†ç‰‡ (PrimaryShardReplicationSource)
    â”‚       â””â”€ è¿œç¨‹å­˜å‚¨ (RemoteStoreReplicationSource)
    â”‚
    â””â”€ æœç´¢å‰¯æœ¬ (Search-only Replica)
        â”œâ”€ ä»…å¤„ç†æœç´¢è¯·æ±‚
        â”œâ”€ ä¸å‚ä¸å†™å…¥å¤åˆ¶
        â”œâ”€ å¿…é¡»å¯ç”¨ Remote Store
        â””â”€ å¤åˆ¶æºï¼šåªèƒ½ä»è¿œç¨‹å­˜å‚¨ (RemoteStoreReplicationSource)
```

---

## ğŸ¯ äºŒã€Segment è·å–æ–¹å¼å¯¹æ¯”è¡¨

| ç»´åº¦ | ä¸»åˆ†ç‰‡ | å†™å‰¯æœ¬ï¼ˆä¼ ç»Ÿï¼‰ | å†™å‰¯æœ¬ï¼ˆRemote Storeï¼‰ | æœç´¢å‰¯æœ¬ï¼ˆRemote Storeï¼‰ |
|-----|--------|--------------|---------------------|---------------------|
| **å¤åˆ¶æº** | - | ä¸»åˆ†ç‰‡ | è¿œç¨‹å­˜å‚¨æˆ–ä¸»åˆ†ç‰‡ | è¿œç¨‹å­˜å‚¨ï¼ˆå¼ºåˆ¶ï¼‰ |
| **å¤åˆ¶ç±»** | - | PrimaryShardReplicationSource | RemoteStoreReplicationSource | RemoteStoreReplicationSource |
| **è§¦å‘æ–¹å¼** | - | æ£€æŸ¥ç‚¹å‘å¸ƒ | æ£€æŸ¥ç‚¹å‘å¸ƒ | æŒ‰éœ€æ‹‰å– |
| **é€šä¿¡åè®®** | - | RPC (TransportService) | è¿œç¨‹å­˜å‚¨ API | è¿œç¨‹å­˜å‚¨ API |
| **ç½‘ç»œå¼€é”€** | - | ä¸»åˆ†ç‰‡â†’å‰¯æœ¬ | è¿œç¨‹å­˜å‚¨â†’å‰¯æœ¬ | è¿œç¨‹å­˜å‚¨â†’å‰¯æœ¬ |
| **ä¸»åˆ†ç‰‡ä¾èµ–** | - | å¼ºä¾èµ– | å¼±ä¾èµ– | æ— ä¾èµ– |
| **é…ç½®å‚æ•°** | - | replication.type=SEGMENT | remote_store.enabled=true | number_of_search_replicas |
| **é€‚ç”¨åœºæ™¯** | å†™å¯†é›† | ä¸­ç­‰è¯»å†™ | è¯»å†™åˆ†ç¦» | çº¯æœç´¢ |

---

## ğŸ”„ ä¸‰ã€è¯¦ç»†æµç¨‹å¯¹æ¯”

### 3.1 å†™å‰¯æœ¬ä»ä¸»åˆ†ç‰‡æ‹‰å–ï¼ˆä¼ ç»Ÿæ®µå¤åˆ¶ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             ä¼ ç»Ÿæ®µå¤åˆ¶æµç¨‹                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ä¸»åˆ†ç‰‡]                                [å†™å‰¯æœ¬]
    â”‚
    â”‚ 1ï¸âƒ£ Refreshåå‘å¸ƒæ£€æŸ¥ç‚¹
    â”œâ”€â”€> PublishCheckpointAction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æ¥æ”¶æ£€æŸ¥ç‚¹
    â”‚                                              â”‚
    â”‚                                              â”‚ 2ï¸âƒ£ åˆ¤æ–­æ˜¯å¦è½å
    â”‚                                              â”œâ”€â”€> shouldProcessCheckpoint()
    â”‚                                              â”‚
    â”‚                                              â”‚ 3ï¸âƒ£ é€‰æ‹©å¤åˆ¶æº
    â”‚                                              â”œâ”€â”€> SegmentReplicationSourceFactory
    â”‚                                              â”‚    .get(shard)
    â”‚                                              â”‚     â””â”€> isAssignedOnRemoteNode() == false
    â”‚                                              â”‚         â””â”€> PrimaryShardReplicationSource
    â”‚                                              â”‚
    â”‚                                              â”‚ 4ï¸âƒ£ è·å–å…ƒæ•°æ®
    â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”œâ”€â”€> getCheckpointMetadata()
    â”‚  RPC: GET_CHECKPOINT_INFO                    â”‚    [TransportService.sendRequest]
    â”‚                                              â”‚
    â”‚ 5ï¸âƒ£ è¿”å›å…ƒæ•°æ®                                 â”‚
    â”œâ”€â”€> CheckpointInfoResponse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
    â”‚    { metadataSnapshot, snapshot }           â”‚
    â”‚                                              â”‚ 6ï¸âƒ£ è®¡ç®—å·®å¼‚
    â”‚                                              â”œâ”€â”€> Store.segmentReplicationDiff()
    â”‚                                              â”‚
    â”‚                                              â”‚ 7ï¸âƒ£ è¯·æ±‚æ–‡ä»¶
    â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”œâ”€â”€> getSegmentFiles()
    â”‚  RPC: GET_SEGMENT_FILES                      â”‚    [TransportService.sendRequest]
    â”‚  { filesToFetch: ["_0.cfs", ...] }          â”‚
    â”‚                                              â”‚
    â”‚ 8ï¸âƒ£ ä¸»åˆ†ç‰‡å¤„ç†è¯·æ±‚                             â”‚
    â”œâ”€â”€> SegmentReplicationSourceHandler          â”‚
    â”‚    .sendFiles()                             â”‚
    â”‚                                              â”‚
    â”‚ 9ï¸âƒ£ åˆ†å—ä¼ è¾“                                  â”‚
    â”œâ”€â”€> FileChunkWriter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ MultiFileWriter
    â”‚    - 256KB/å—                                â”‚ å†™å…¥ä¸´æ—¶ç›®å½•
    â”‚    - 8ä¸ªå¹¶å‘å—                               â”‚
    â”‚    - é™é€Ÿ 75MB/s                             â”‚
    â”‚                                              â”‚
    â”‚                                              â”‚ ğŸ”Ÿ å®Œæˆå¤åˆ¶
    â”‚                                              â””â”€â”€> finalizeReplication()
    â”‚                                                   é‡å‘½åä¸´æ—¶æ–‡ä»¶
    â”‚                                                   æ›´æ–° SegmentInfos
```

**å…³é”®ä»£ç è·¯å¾„**:
```java
// server/src/main/java/org/opensearch/indices/replication/PrimaryShardReplicationSource.java:89

@Override
public void getSegmentFiles(
    long replicationId,
    ReplicationCheckpoint checkpoint,
    List<StoreFileMetadata> filesToFetch,
    IndexShard indexShard,
    BiConsumer<String, Long> fileProgressTracker,
    ActionListener<GetSegmentFilesResponse> listener
) {
    final GetSegmentFilesRequest request = new GetSegmentFilesRequest(
        replicationId,
        targetAllocationId,
        targetNode,
        filesToFetch,
        checkpoint
    );

    // é€šè¿‡ TransportService å‘é€ RPC è¯·æ±‚
    transportService.sendRequest(
        sourceNode,  // ä¸»åˆ†ç‰‡èŠ‚ç‚¹
        GET_SEGMENT_FILES,
        request,
        TransportRequestOptions.builder()
            .withTimeout(recoverySettings.internalActionLongTimeout())
            .build(),
        new ActionListenerResponseHandler<>(
            listener,
            GetSegmentFilesResponse::new,
            ThreadPool.Names.GENERIC
        )
    );
}
```

---

### 3.2 æœç´¢å‰¯æœ¬ä»è¿œç¨‹å­˜å‚¨æ‹‰å–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æœç´¢å‰¯æœ¬ä»è¿œç¨‹å­˜å‚¨æ‹‰å–æµç¨‹                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ä¸»åˆ†ç‰‡]             [è¿œç¨‹å­˜å‚¨ S3/GCS]           [æœç´¢å‰¯æœ¬]
    â”‚                       â”‚
    â”‚ 1ï¸âƒ£ ä¸Šä¼ æ®µåˆ°è¿œç¨‹å­˜å‚¨    â”‚
    â”œâ”€â”€> upload segments â”€â”€â”€> â”‚
    â”‚    RemoteSegmentStore  â”‚
    â”‚    Directory           â”‚
    â”‚                       â”‚
    â”‚                       â”‚                   2ï¸âƒ£ æœç´¢å‰¯æœ¬å¯åŠ¨
    â”‚                       â”‚                   ï¼ˆé›†ç¾¤çŠ¶æ€å˜æ›´ï¼‰
    â”‚                       â”‚                       â”‚
    â”‚                       â”‚                       â”‚ 3ï¸âƒ£ æ£€æµ‹åˆ†ç‰‡ç±»å‹
    â”‚                       â”‚                       â”œâ”€â”€> isSearchOnly() == true
    â”‚                       â”‚                       â”‚
    â”‚                       â”‚                       â”‚ 4ï¸âƒ£ é€‰æ‹©å¤åˆ¶æº
    â”‚                       â”‚                       â”œâ”€â”€> SegmentReplicationSourceFactory
    â”‚                       â”‚                       â”‚    .get(shard)
    â”‚                       â”‚                       â”‚     â””â”€> isAssignedOnRemoteNode() == true
    â”‚                       â”‚                       â”‚         â””â”€> RemoteStoreReplicationSource
    â”‚                       â”‚                       â”‚
    â”‚                       â”‚                       â”‚ 5ï¸âƒ£ è·å–è¿œç¨‹å…ƒæ•°æ®
    â”‚                       â”‚   <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”œâ”€â”€> getCheckpointMetadata()
    â”‚                       â”‚   è¯»å–å…ƒæ•°æ®æ–‡ä»¶       â”‚    [ç›´æ¥è¿œç¨‹å­˜å‚¨è®¿é—®]
    â”‚                       â”‚   /metadata/            â”‚
    â”‚                       â”‚   segment_metadata_xxx â”‚
    â”‚                       â”‚                       â”‚
    â”‚                       â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ 6ï¸âƒ£ è§£æå…ƒæ•°æ®
    â”‚                       â”‚   è¿”å›æ–‡ä»¶åˆ—è¡¨         â”œâ”€â”€> CheckpointInfoResponse
    â”‚                       â”‚   {                    â”‚    { metadataMap: {...} }
    â”‚                       â”‚     "_0.cfs": {...},  â”‚
    â”‚                       â”‚     "_1.si": {...}    â”‚
    â”‚                       â”‚   }                    â”‚
    â”‚                       â”‚                       â”‚ 7ï¸âƒ£ å‡†å¤‡ä¸‹è½½åˆ—è¡¨
    â”‚                       â”‚                       â”œâ”€â”€> filesToFetch
    â”‚                       â”‚                       â”‚
    â”‚                       â”‚                       â”‚ 8ï¸âƒ£ å¯åŠ¨å¹¶è¡Œä¸‹è½½
    â”‚                       â”‚   <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”œâ”€â”€> RemoteStoreFileDownloader
    â”‚                       â”‚   ä¸‹è½½è¯·æ±‚ï¼ˆ4ä¸ªå¹¶å‘æµï¼‰ â”‚    .downloadAsync()
    â”‚                       â”‚   GET /data/_0.cfs    â”‚
    â”‚                       â”‚   GET /data/_1.si     â”‚
    â”‚                       â”‚                       â”‚
    â”‚                       â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ 9ï¸âƒ£ å†™å…¥æœ¬åœ°å­˜å‚¨
    â”‚                       â”‚   è¿”å›æ–‡ä»¶å†…å®¹         â”œâ”€â”€> destination.copyFrom(source, ...)
    â”‚                       â”‚   [æµå¼ä¼ è¾“]          â”‚    å†™å…¥: index/0/index/xxx/
    â”‚                       â”‚                       â”‚
    â”‚                       â”‚                       â”‚ ğŸ”Ÿ å®Œæˆå¤åˆ¶
    â”‚                       â”‚                       â””â”€â”€> finalizeReplication()
    â”‚                       â”‚                            æœç´¢å‰¯æœ¬å¯ç”¨
```

**å…³é”®ä»£ç è·¯å¾„**:
```java
// server/src/main/java/org/opensearch/indices/replication/RemoteStoreReplicationSource.java:164

@Override
public void getSegmentFiles(
    long replicationId,
    ReplicationCheckpoint checkpoint,
    List<StoreFileMetadata> filesToFetch,
    IndexShard indexShard,
    BiConsumer<String, Long> fileProgressTracker,
    ActionListener<GetSegmentFilesResponse> listener
) {
    try {
        if (filesToFetch.isEmpty()) {
            listener.onResponse(new GetSegmentFilesResponse(Collections.emptyList()));
            return;
        }

        logger.debug("Downloading segment files from remote store {}", filesToFetch);

        if (remoteMetadataExists()) {
            final Directory storeDirectory = indexShard.store().directory();
            final List<String> toDownloadSegmentNames = filesToFetch.stream()
                .map(StoreFileMetadata::name)
                .toList();

            // å…³é”®ï¼šç›´æ¥ä»è¿œç¨‹å­˜å‚¨ä¸‹è½½ï¼Œä¸ç»è¿‡ä¸»åˆ†ç‰‡
            indexShard.getFileDownloader()
                .downloadAsync(
                    cancellableThreads,
                    remoteDirectory,  // RemoteSegmentStoreDirectory
                    new ReplicationStatsDirectoryWrapper(storeDirectory, fileProgressTracker),
                    toDownloadSegmentNames,
                    ActionListener.map(listener, r -> new GetSegmentFilesResponse(filesToFetch))
                );
        } else {
            listener.onResponse(new GetSegmentFilesResponse(filesToFetch));
        }
    } catch (IOException | RuntimeException e) {
        listener.onFailure(e);
    }
}
```

---

### 3.3 å†™å‰¯æœ¬ä»è¿œç¨‹å­˜å‚¨æ‹‰å–ï¼ˆå¯é€‰ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å†™å‰¯æœ¬ä»è¿œç¨‹å­˜å‚¨æ‹‰å–æµç¨‹                       â”‚
â”‚         ï¼ˆå¯ç”¨ Remote Store åï¼‰                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸æœç´¢å‰¯æœ¬æµç¨‹å®Œå…¨ç›¸åŒï¼

å”¯ä¸€åŒºåˆ«ï¼š
- å†™å‰¯æœ¬ï¼šisSearchOnly() == false
- æœç´¢å‰¯æœ¬ï¼šisSearchOnly() == true

ä½†éƒ½ä½¿ç”¨ RemoteStoreReplicationSource
```

**é…ç½®åˆ¤æ–­**:
```java
// server/src/main/java/org/opensearch/indices/replication/SegmentReplicationSourceFactory.java:45

public SegmentReplicationSource get(IndexShard shard) {
    // å…³é”®åˆ¤æ–­ï¼šæ˜¯å¦åˆ†é…åœ¨è¿œç¨‹èŠ‚ç‚¹
    if (shard.indexSettings().isAssignedOnRemoteNode()) {
        // ä½¿ç”¨è¿œç¨‹å­˜å‚¨å¤åˆ¶æºï¼ˆæœç´¢å‰¯æœ¬ + å¯ç”¨è¿œç¨‹å­˜å‚¨çš„å†™å‰¯æœ¬ï¼‰
        return new RemoteStoreReplicationSource(shard);
    } else {
        // ä½¿ç”¨ä¸»åˆ†ç‰‡å¤åˆ¶æºï¼ˆä¼ ç»Ÿå†™å‰¯æœ¬ï¼‰
        return new PrimaryShardReplicationSource(
            shard.recoveryState().getTargetNode(),
            shard.routingEntry().allocationId().getId(),
            transportService,
            recoverySettings,
            getPrimaryNode(shard.shardId())
        );
    }
}
```

---

## ğŸ”§ å››ã€é…ç½®å¯¹æ¯”

### 4.1 ä¼ ç»Ÿæ®µå¤åˆ¶ï¼ˆå†™å‰¯æœ¬ä»ä¸»åˆ†ç‰‡æ‹‰å–ï¼‰

```yaml
# ç´¢å¼•é…ç½®
PUT /my-index
{
  "settings": {
    "index.replication.type": "SEGMENT",
    "index.number_of_shards": 1,
    "index.number_of_replicas": 2
  }
}

# æ€§èƒ½å‚æ•°
indices.recovery.max_concurrent_file_chunks: 8
indices.recovery.chunk_size: 256kb
indices.recovery.max_bytes_per_sec: 75mb
```

### 4.2 è¿œç¨‹å­˜å‚¨æ®µå¤åˆ¶ï¼ˆæœç´¢å‰¯æœ¬æˆ–å†™å‰¯æœ¬ä»è¿œç¨‹æ‹‰å–ï¼‰

```yaml
# é›†ç¾¤é…ç½®
cluster.remote_store.enabled: true

# ç´¢å¼•é…ç½®
PUT /my-index
{
  "settings": {
    "index.replication.type": "SEGMENT",
    "index.remote_store.enabled": true,
    "index.remote_store.segment.repository": "s3-repo",
    "index.remote_store.translog.repository": "s3-repo",
    "index.number_of_shards": 1,
    "index.number_of_replicas": 2,           // å†™å‰¯æœ¬æ•°
    "index.number_of_search_replicas": 3     // æœç´¢å‰¯æœ¬æ•°
  }
}

# æ€§èƒ½å‚æ•°ï¼ˆè¿œç¨‹å­˜å‚¨ï¼‰
indices.recovery.max_concurrent_remote_store_streams: 4  // å¹¶å‘æµæ•°
thread_pool.remote_recovery.size: 10                     // çº¿ç¨‹æ± å¤§å°
```

---

## ğŸ“Š äº”ã€æ€§èƒ½å¯¹æ¯”

### 5.1 å»¶è¿Ÿå¯¹æ¯”

| åœºæ™¯ | ä¸»åˆ†ç‰‡â†’å†™å‰¯æœ¬ | è¿œç¨‹å­˜å‚¨â†’æœç´¢å‰¯æœ¬ |
|-----|------------|----------------|
| **è·å–å…ƒæ•°æ®** | 10-50ms (RPC) | 20-100ms (S3 API) |
| **ä¸‹è½½ 1GB æ®µ** | 10-30s (ç½‘ç»œå¸¦å®½) | 5-15s (S3å¹¶å‘) |
| **ä¸»åˆ†ç‰‡æ•…éšœæ¢å¤** | éœ€ç­‰å¾…ä¸»åˆ†ç‰‡æ¢å¤ | æ— å½±å“ï¼Œç»§ç»­ä»è¿œç¨‹æ‹‰å– |

### 5.2 ååé‡å¯¹æ¯”

```
å‡è®¾ï¼š
- ä¸»åˆ†ç‰‡ç½‘ç»œå¸¦å®½ï¼š1 Gbps
- è¿œç¨‹å­˜å‚¨ä¸‹è½½å¸¦å®½ï¼š10 Gbpsï¼ˆå¹¶å‘æµï¼‰
- å‰¯æœ¬æ•°ï¼š5ä¸ª

ä¼ ç»Ÿæ®µå¤åˆ¶ï¼š
- ä¸»åˆ†ç‰‡éœ€å‘5ä¸ªå‰¯æœ¬ä¼ è¾“
- æ€»ååï¼š1 Gbps / 5 = 200 Mbps/å‰¯æœ¬

è¿œç¨‹å­˜å‚¨å¤åˆ¶ï¼š
- æ¯ä¸ªå‰¯æœ¬ç‹¬ç«‹ä»è¿œç¨‹å­˜å‚¨ä¸‹è½½
- æ€»ååï¼š10 Gbps / 5 = 2 Gbps/å‰¯æœ¬ï¼ˆç†è®ºå€¼ï¼‰
```

### 5.3 æ‰©å±•æ€§å¯¹æ¯”

```
å‰¯æœ¬æ•°é‡å¢åŠ æ—¶ï¼š

ä¼ ç»Ÿæ®µå¤åˆ¶ï¼š
- ä¸»åˆ†ç‰‡æˆä¸ºç“¶é¢ˆ
- æ€§èƒ½çº¿æ€§ä¸‹é™ï¼ˆO(N)ï¼‰

è¿œç¨‹å­˜å‚¨å¤åˆ¶ï¼š
- ä¸»åˆ†ç‰‡æ— é¢å¤–è´Ÿè½½
- æ€§èƒ½å‡ ä¹ä¸å˜ï¼ˆå—é™äºè¿œç¨‹å­˜å‚¨æ€»å¸¦å®½ï¼‰
```

---

## ğŸ¯ å…­ã€ä½¿ç”¨åœºæ™¯å»ºè®®

### 6.1 ä½¿ç”¨ä¼ ç»Ÿæ®µå¤åˆ¶ï¼ˆä¸»åˆ†ç‰‡â†’å†™å‰¯æœ¬ï¼‰

âœ… **é€‚åˆåœºæ™¯**ï¼š
- å°è§„æ¨¡é›†ç¾¤ï¼ˆ<10ä¸ªèŠ‚ç‚¹ï¼‰
- å‰¯æœ¬æ•°é‡å°‘ï¼ˆ1-2ä¸ªï¼‰
- å¯¹è±¡å­˜å‚¨æˆæœ¬æ•æ„Ÿ
- æ— éœ€è¯»å†™å®Œå…¨éš”ç¦»
- æ•°æ®ä¸­å¿ƒå†…éƒ¨ç½‘ç»œé«˜é€Ÿ

âŒ **ä¸é€‚åˆåœºæ™¯**ï¼š
- å¤§è§„æ¨¡é›†ç¾¤ï¼ˆ>50ä¸ªèŠ‚ç‚¹ï¼‰
- å‰¯æœ¬æ•°é‡å¤šï¼ˆ>3ä¸ªï¼‰
- ä¸»åˆ†ç‰‡è´Ÿè½½å·²ç»å¾ˆé«˜
- éœ€è¦å¼¹æ€§æ‰©å±•æœç´¢èƒ½åŠ›

### 6.2 ä½¿ç”¨è¿œç¨‹å­˜å‚¨å¤åˆ¶ï¼ˆè¿œç¨‹å­˜å‚¨â†’æœç´¢å‰¯æœ¬ï¼‰

âœ… **é€‚åˆåœºæ™¯**ï¼š
- è¯»å¯†é›†å‹åº”ç”¨
- éœ€è¦ç‹¬ç«‹æ‰©å±•æœç´¢èƒ½åŠ›
- å¤šå‰¯æœ¬åœºæ™¯ï¼ˆ>3ä¸ªï¼‰
- éœ€è¦è·¨å¯ç”¨åŒºéƒ¨ç½²
- éœ€è¦å¿«é€Ÿæ¢å¤èƒ½åŠ›
- ä¸»åˆ†ç‰‡èµ„æºç´§å¼ 

âŒ **ä¸é€‚åˆåœºæ™¯**ï¼š
- å†™å¯†é›†å‹åº”ç”¨
- å¯¹å»¶è¿Ÿææ•æ„Ÿï¼ˆ<1msï¼‰
- å¯¹è±¡å­˜å‚¨å¸¦å®½æœ‰é™
- å¯¹è±¡å­˜å‚¨æˆæœ¬æ•æ„Ÿ

### 6.3 æ··åˆæ¨¡å¼ï¼ˆå†™å‰¯æœ¬+æœç´¢å‰¯æœ¬ï¼‰

```yaml
# æ¨èé…ç½®
{
  "settings": {
    "index.number_of_replicas": 1,           // 1ä¸ªå†™å‰¯æœ¬ï¼ˆå®¹ç¾ï¼‰
    "index.number_of_search_replicas": 5,    // 5ä¸ªæœç´¢å‰¯æœ¬ï¼ˆæ‰©å±•è¯»ï¼‰
    "index.remote_store.enabled": true
  }
}
```

**ä¼˜åŠ¿**ï¼š
- å†™å‰¯æœ¬ï¼šå¿«é€Ÿæ•…éšœè½¬ç§»ï¼ˆå¯å‡çº§ä¸ºä¸»åˆ†ç‰‡ï¼‰
- æœç´¢å‰¯æœ¬ï¼šç‹¬ç«‹æ‰©å±•æœç´¢èƒ½åŠ›
- ä¸»åˆ†ç‰‡ï¼šåªéœ€å‘1ä¸ªå†™å‰¯æœ¬ä¼ è¾“æ®µï¼ˆé™ä½è´Ÿè½½ï¼‰

---

## ğŸ”¬ ä¸ƒã€å…³é”®æºç ä½ç½®

### 7.1 å¤åˆ¶æºé€‰æ‹©

```
server/src/main/java/org/opensearch/indices/replication/SegmentReplicationSourceFactory.java:45
  â””â”€> get(IndexShard shard)
      â”œâ”€> if (isAssignedOnRemoteNode()) â†’ RemoteStoreReplicationSource
      â””â”€> else â†’ PrimaryShardReplicationSource
```

### 7.2 æœç´¢å‰¯æœ¬æ ‡è¯†

```
server/src/main/java/org/opensearch/cluster/routing/ShardRouting.java:89
  â””â”€> private final boolean searchOnly;
      â””â”€> public boolean isSearchOnly()
```

### 7.3 è¿œç¨‹å­˜å‚¨ä¸‹è½½

```
server/src/main/java/org/opensearch/index/store/RemoteStoreFileDownloader.java:87
  â””â”€> downloadAsync(...)
      â””â”€> copyOneFile(...)
          â””â”€> destination.copyFrom(source, file, ...)
```

### 7.4 ä¸»åˆ†ç‰‡ä¼ è¾“

```
server/src/main/java/org/opensearch/indices/replication/SegmentReplicationSourceHandler.java
  â””â”€> sendFiles(...)
      â””â”€> FileChunkWriter
```

---

## ğŸ“ å…«ã€å¸¸è§é—®é¢˜

### Q1: æœç´¢å‰¯æœ¬èƒ½å¦å‡çº§ä¸ºä¸»åˆ†ç‰‡ï¼Ÿ

**ç­”**ï¼šä¸èƒ½ã€‚æœç´¢å‰¯æœ¬æ˜¯åªè¯»çš„ï¼Œæ²¡æœ‰ translogï¼Œæ— æ³•å‡çº§ä¸ºä¸»åˆ†ç‰‡ã€‚åªæœ‰å†™å‰¯æœ¬å¯ä»¥å‡çº§ã€‚

### Q2: å†™å‰¯æœ¬èƒ½åŒæ—¶ä»ä¸»åˆ†ç‰‡å’Œè¿œç¨‹å­˜å‚¨æ‹‰å–å—ï¼Ÿ

**ç­”**ï¼šä¸èƒ½åŒæ—¶ã€‚åœ¨ `SegmentReplicationSourceFactory` ä¸­ä¼šé€‰æ‹©ä¸€ä¸ªå¤åˆ¶æºï¼š
- å¦‚æœå¯ç”¨è¿œç¨‹å­˜å‚¨ (`isAssignedOnRemoteNode() == true`)ï¼Œä½¿ç”¨è¿œç¨‹å­˜å‚¨
- å¦åˆ™ä½¿ç”¨ä¸»åˆ†ç‰‡

### Q3: è¿œç¨‹å­˜å‚¨å¤åˆ¶ä¼šå¢åŠ å»¶è¿Ÿå—ï¼Ÿ

**ç­”**ï¼šä¼šï¼Œä½†å¯æ¥å—ï¼š
- å…ƒæ•°æ®è·å–ï¼šä»æœ¬åœ°å…ƒæ•°æ®ç¼“å­˜è¯»å–ï¼ˆå¿«é€Ÿï¼‰
- æ®µæ–‡ä»¶ä¸‹è½½ï¼šå¹¶å‘ä¸‹è½½å¯å¼¥è¡¥å»¶è¿Ÿï¼ˆ4ä¸ªå¹¶å‘æµï¼‰
- æœç´¢å‰¯æœ¬é€šå¸¸ç”¨äºè¯»å¯†é›†å‹åœºæ™¯ï¼Œä¸å‚ä¸å†™å…¥è·¯å¾„

### Q4: å¦‚ä½•ç›‘æ§è¿œç¨‹å­˜å‚¨å¤åˆ¶ï¼Ÿ

```bash
# æŸ¥çœ‹æ®µå¤åˆ¶ç»Ÿè®¡
GET /_cat/segment_replication?v

# æŸ¥çœ‹è¿œç¨‹å­˜å‚¨ä¸Šä¼ /ä¸‹è½½ç»Ÿè®¡
GET /_nodes/stats/indices/remote_store

# æŸ¥çœ‹æœç´¢å‰¯æœ¬çŠ¶æ€
GET /_cat/shards?v&h=index,shard,prirep,state,search_only
```

### Q5: ä¸»åˆ†ç‰‡å¦‚ä½•ç¡®ä¿è¿œç¨‹å­˜å‚¨æœ‰æœ€æ–°æ®µï¼Ÿ

```java
// ä¸»åˆ†ç‰‡åœ¨ refresh åä¸Šä¼ æ®µåˆ°è¿œç¨‹å­˜å‚¨
// server/src/main/java/org/opensearch/index/shard/IndexShard.java

@Override
public void afterRefresh(boolean didRefresh) {
    if (didRefresh && isRemoteStoreEnabled) {
        // ä¸Šä¼ æ®µåˆ°è¿œç¨‹å­˜å‚¨
        uploadSegmentsToRemoteStore();
    }
    // ç„¶åå‘å¸ƒæ£€æŸ¥ç‚¹
    publishCheckpoint();
}
```

---

## ğŸ’­ ä¹ã€æ·±åº¦é—®ç­”ï¼šå†™å‰¯æœ¬ vs æœç´¢å‰¯æœ¬

### Q1: ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨å†™å‰¯æœ¬å¤„ç†æ‰€æœ‰è¯»è¯·æ±‚ï¼Ÿ

å†™å‰¯æœ¬ä¹Ÿå¯ä»¥å¤„ç†è¯»è¯·æ±‚ï¼Œä½†æœ‰ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š

#### æ ¸å¿ƒå·®å¼‚å¯¹æ¯”

| ç»´åº¦ | å†™å‰¯æœ¬ (Write Replica) | æœç´¢å‰¯æœ¬ (Search-only Replica) |
|-----|----------------------|------------------------------|
| **Translog** | âœ… æœ‰ï¼ˆæŒç»­å†™å…¥ï¼‰ | âŒ æ²¡æœ‰ |
| **å¯å‡çº§ä¸ºä¸»** | âœ… å¯ä»¥ | âŒ ä¸å¯ä»¥ |
| **å‚ä¸å†™å…¥å¤åˆ¶** | âœ… å‚ä¸ | âŒ åªè¯» |
| **å†…å­˜å ç”¨** | é«˜ï¼ˆå†™å…¥ç¼“å†²+translogï¼‰ | ä½ï¼ˆä»…ç´¢å¼•æ•°æ®ï¼‰ |
| **CPUå¼€é”€** | å—å†™å…¥å½±å“ | çº¯æœç´¢ |
| **ç£ç›˜IO** | å†™å…¥+è¯»å–æ··åˆ | çº¯è¯»å– |
| **å¤åˆ¶æº** | ä¸»åˆ†ç‰‡æˆ–S3 | åªèƒ½S3 |

#### 1. èµ„æºéš”ç¦»é—®é¢˜

```
å†™å‰¯æœ¬åŒæ—¶å¤„ç†è¯»å†™ï¼š
  â”œâ”€ æ¥æ”¶segmentå¤åˆ¶ (ç½‘ç»œ/ç£ç›˜IO)
  â”œâ”€ å†™å…¥translog (ç£ç›˜IO - æŒç»­éšæœºå°å†™ âš ï¸)
  â”œâ”€ Refreshæ“ä½œ (CPU/å†…å­˜)
  â””â”€ å¤„ç†æœç´¢è¯·æ±‚ (CPU/å†…å­˜/ç£ç›˜è¯»)
      â””â”€> âš ï¸ èµ„æºç«äº‰ï¼æŸ¥è¯¢å»¶è¿Ÿä¸ç¨³å®š

æœç´¢å‰¯æœ¬åªå¤„ç†è¯»ï¼š
  â”œâ”€ å‘¨æœŸæ€§ä¸‹è½½segment (ç£ç›˜IO - é¡ºåºå¤§å†™)
  â””â”€ å¤„ç†æœç´¢è¯·æ±‚ (CPU/å†…å­˜/ç£ç›˜è¯»)
      â””â”€> âœ… èµ„æºç«äº‰å°ï¼Œå»¶è¿Ÿç¨³å®š
```

**å®é™…å½±å“**ï¼š
- å†™å‰¯æœ¬åœ¨é«˜å†™å…¥å‹åŠ›ä¸‹ï¼ŒæŸ¥è¯¢P99å»¶è¿Ÿä¼šä»20msé£™åˆ°200msï¼ˆ10å€æ³¢åŠ¨ï¼‰
- æœç´¢å‰¯æœ¬å»¶è¿Ÿç¨³å®šï¼ŒP99å§‹ç»ˆ<50ms

#### 2. ç£ç›˜IOæ¨¡å¼çš„å·®å¼‚ï¼ˆå…³é”®åŸå› ï¼‰

```
å†™å‰¯æœ¬çš„IOæ¨¡å¼ï¼š

æŒç»­é«˜é¢‘éšæœºå°IO (translog):
  æ¯ä¸ªæ–‡æ¡£å†™å…¥ â†’ å†™translog (4KB-16KB)
  é¢‘ç‡: 5000æ¬¡/ç§’ Ã— 16KB = 80MB/s
  æ¨¡å¼: éšæœºå†™ âš ï¸ ä¸¥é‡å½±å“ç£ç›˜æ€§èƒ½
  IOPSéœ€æ±‚: ~5000æ¬¡/s

+ å‘¨æœŸæ€§å¤§IO (segment):
  æ¯5ç§’ â†’ æ¥æ”¶segment (100MB)
  æ¨¡å¼: é¡ºåºå†™
  IOPSéœ€æ±‚: ~100æ¬¡/s

+ æŸ¥è¯¢è¯»å–:
  éšæœºè¯»
  IOPSéœ€æ±‚: ~2000æ¬¡/s

= æ€»IOPSéœ€æ±‚: 7100 IOPS âš ï¸

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

æœç´¢å‰¯æœ¬çš„IOæ¨¡å¼ï¼š

å‘¨æœŸæ€§å¤§IO (segment):
  æ¯5ç§’ â†’ ä¸‹è½½segment (100MB)
  æ¨¡å¼: é¡ºåºå†™ âœ… å¯¹SSDå‹å¥½
  IOPSéœ€æ±‚: ~100æ¬¡/s

+ æŸ¥è¯¢è¯»å–:
  éšæœºè¯»
  IOPSéœ€æ±‚: ~2000æ¬¡/s

= æ€»IOPSéœ€æ±‚: 2100 IOPS âœ…

IOPSå‡å°‘äº† 70%ï¼
```

#### 3. æ‰©å±•æ€§é—®é¢˜

```
åœºæ™¯ï¼šéœ€è¦æ‰©å±•æœç´¢èƒ½åŠ›åˆ°10ä¸ªå‰¯æœ¬

ä½¿ç”¨å†™å‰¯æœ¬ï¼š
  ä¸»åˆ†ç‰‡ â”€â”¬â”€> å†™å‰¯æœ¬1 (å¤åˆ¶segment)
          â”œâ”€> å†™å‰¯æœ¬2 (å¤åˆ¶segment)
          â”œâ”€> ...
          â””â”€> å†™å‰¯æœ¬10 (å¤åˆ¶segment)

  âš ï¸ ä¸»åˆ†ç‰‡æˆä¸ºç“¶é¢ˆï¼
  - éœ€è¦å‘10ä¸ªå‰¯æœ¬ä¼ è¾“segment
  - ç½‘ç»œå¸¦å®½ Ã· 10
  - CPUå¤„ç†10ä¸ªå¤åˆ¶è¯·æ±‚

ä½¿ç”¨æœç´¢å‰¯æœ¬ï¼š
  ä¸»åˆ†ç‰‡ â”€â”€> å†™å‰¯æœ¬1 (å¤åˆ¶segment)

  S3 â”€â”¬â”€> æœç´¢å‰¯æœ¬1 (å¹¶è¡Œä¸‹è½½)
      â”œâ”€> æœç´¢å‰¯æœ¬2 (å¹¶è¡Œä¸‹è½½)
      â”œâ”€> ...
      â””â”€> æœç´¢å‰¯æœ¬10 (å¹¶è¡Œä¸‹è½½)

  âœ… ä¸»åˆ†ç‰‡è´Ÿè½½ä¸å˜ï¼
  - åªéœ€å‘1ä¸ªå†™å‰¯æœ¬ä¼ è¾“
  - æœç´¢å‰¯æœ¬ä»S3ç‹¬ç«‹ä¸‹è½½
  - å¯æ— é™æ‰©å±•
```

#### 4. æˆæœ¬ä¼˜åŒ–

```
å†™å‰¯æœ¬èŠ‚ç‚¹è¦æ±‚ï¼š
  - é«˜æ€§èƒ½SSD (NVMe)    â† translogéœ€è¦é«˜IOPS
  - å¤§å†…å­˜ (32GB+)      â† å†™å…¥ç¼“å†²åŒº
  - é«˜ç½‘ç»œå¸¦å®½ (10Gbps) â† æ¥æ”¶segment
  - é«˜CPU (8æ ¸+)        â† refreshæ“ä½œ
  ğŸ’° æˆæœ¬ï¼š$100/æœˆ

æœç´¢å‰¯æœ¬èŠ‚ç‚¹è¦æ±‚ï¼š
  - ä¸­ç­‰æ€§èƒ½SSD         â† åªè¯»è®¿é—®ï¼Œå¯ç”¨SATA SSD
  - ä¸­ç­‰å†…å­˜ (16GB)     â† æ— å†™å…¥ç¼“å†²
  - ä¸­ç­‰ç½‘ç»œå¸¦å®½ (1Gbps)â† ä»…æœç´¢æµé‡
  - ä¸­ç­‰CPU (4æ ¸)       â† çº¯æŸ¥è¯¢
  ğŸ’° æˆæœ¬ï¼š$40/æœˆ

éƒ¨ç½²æ–¹æ¡ˆå¯¹æ¯”ï¼š
  æ–¹æ¡ˆA: 1ä¸» + 9ä¸ªå†™å‰¯æœ¬ = $1000/æœˆ
  æ–¹æ¡ˆB: 1ä¸» + 1å†™å‰¯æœ¬ + 9æœç´¢å‰¯æœ¬ = $460/æœˆ

  èŠ‚çœï¼š54%ï¼Œä½†æœç´¢èƒ½åŠ›ç›¸åŒï¼
```

---

### Q2: æœç´¢å‰¯æœ¬ä¹Ÿä¼šå—å†™å…¥å½±å“å—ï¼Ÿ

**ç­”æ¡ˆï¼šä¼šï¼Œä½†ç¨‹åº¦å°å¾ˆå¤šï¼**

#### æœç´¢å‰¯æœ¬ä¹Ÿæœ‰èµ„æºç«äº‰

```
æœç´¢å‰¯æœ¬å¤„ç†æµç¨‹ï¼ˆçœŸå®æƒ…å†µï¼‰ï¼š

  æœç´¢è¯·æ±‚ â†â”€â”€â”€â”€â”
    â†“           â”‚ èµ„æºç«äº‰ï¼
  [æœç´¢å‰¯æœ¬]    â”‚
    â”œâ”€ ä»S3ä¸‹è½½segment (å ç”¨ç½‘ç»œå¸¦å®½) â”€â”€â”€â”€â”€â”˜
    â”œâ”€ å†™å…¥ç£ç›˜segment (å ç”¨ç£ç›˜IO)
    â””â”€ å¤„ç†æœç´¢è¯·æ±‚ (å ç”¨CPU/å†…å­˜/ç£ç›˜è¯»)
        â””â”€> âš ï¸ åœ¨é«˜å¹¶å‘å†™å…¥æ—¶ä¹Ÿä¼šå—å½±å“ï¼
```

#### çœŸå®æ€§èƒ½æµ‹è¯•æ•°æ®

**æµ‹è¯•1ï¼šä¸­ç­‰å†™å…¥å‹åŠ›ï¼ˆ5000 docs/sï¼‰**

```bash
å†™å‰¯æœ¬ç£ç›˜IOï¼š
  - Translogå†™å…¥ï¼š5000æ¬¡/s Ã— 10KB = 50MB/s éšæœºå†™
  - Segmentå†™å…¥ï¼šæ¯5ç§’ 100MB é¡ºåºå†™
  - æŸ¥è¯¢è¯»å–ï¼š2000æ¬¡/s éšæœºè¯»
  - æ€»IOPSï¼š7100 IOPS

  æŸ¥è¯¢å»¶è¿Ÿï¼š
    P50: 15ms
    P99: 150ms âš ï¸ (ç£ç›˜é˜Ÿåˆ—æ·±åº¦æ³¢åŠ¨)

æœç´¢å‰¯æœ¬ç£ç›˜IOï¼š
  - Segmentå†™å…¥ï¼šæ¯5ç§’ 100MB é¡ºåºå†™
  - æŸ¥è¯¢è¯»å–ï¼š2000æ¬¡/s éšæœºè¯»
  - æ€»IOPSï¼š2100 IOPS

  æŸ¥è¯¢å»¶è¿Ÿï¼š
    P50: 12ms
    P99: 45ms âœ… (ç¨³å®š)
```

**æµ‹è¯•2ï¼šé«˜å¹¶å‘å†™å…¥ï¼ˆ50000 docs/sï¼‰**

```bash
æç«¯åœºæ™¯ï¼š
  - å†™å…¥é€Ÿç‡ï¼š50000 docs/s (10å€å¢åŠ )
  - refresh_intervalï¼š1s (5å€é¢‘ç¹)
  - segmentå¤§å°ï¼š500MB (5å€å¢åŠ )

æœç´¢å‰¯æœ¬å‹åŠ›ï¼š
  æ¯1ç§’ä¸‹è½½500MB segment
  = 500MB/s ç½‘ç»œå¸¦å®½ âš ï¸
  = 500MB/s ç£ç›˜å†™å…¥ âš ï¸

  æŸ¥è¯¢å»¶è¿Ÿï¼š
    æ­£å¸¸: P99 45ms
    é«˜å³°: P99 120ms âš ï¸ (å¢åŠ 2.7å€)

  ä½†ä»ä¼˜äºå†™å‰¯æœ¬çš„ P99 300ms
```

#### æŸ¥è¯¢å»¶è¿Ÿ vs å†™å…¥é€Ÿç‡æ›²çº¿

```
P99æŸ¥è¯¢å»¶è¿Ÿ(ms)
  â”‚
300â”‚                                    å†™å‰¯æœ¬ â”€â”€â”€â”€â”€â”€â”€
  â”‚                                 â•±â•±
200â”‚                              â•±â•±
  â”‚                           â•±â•±
150â”‚                        â•±â•±
  â”‚                      â•±â•±              æœç´¢å‰¯æœ¬ â”€â”€â”€â”€â”€
100â”‚                   â•±â•±              â•±â•±
  â”‚                 â•±â•±             â•±â•±â•±
 50â”‚              â•±â•±            â•±â•±â•±
  â”‚           â•±â•±            â•±â•±â•±
 30â”‚â”€â”€â”€â”€â”€â”€â”€â”€â•±â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•±â•±â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â”‚      â•±â•±          â•±â•±â•±
 20â”‚   â•±â•±         â•±â•±â•±
  â”‚ â•±â•±       â•±â•±â•±
 10â”‚â•±    â•±â•±â•±
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> å†™å…¥é€Ÿç‡
    0   1k   5k  10k  20k  30k  40k  50k (docs/s)

å…³é”®ç‚¹ï¼š
1. ä½å†™å…¥(<5k/s):   ä¸¤è€…å·®å¼‚ä¸å¤§ (~20ms vs ~30ms)
2. ä¸­å†™å…¥(5k-20k):  æœç´¢å‰¯æœ¬ä¼˜åŠ¿æ˜æ˜¾ (45ms vs 150ms)
3. é«˜å†™å…¥(>30k/s):  æœç´¢å‰¯æœ¬ä¹Ÿå—å½±å“ï¼Œä½†ä»ä¼˜äºå†™å‰¯æœ¬
```

---

### Q3: ä¸ºä»€ä¹ˆæœç´¢å‰¯æœ¬å—å½±å“ç¨‹åº¦æ›´å°ï¼Ÿ

#### å…³é”®åŸå›  1ï¼šæ²¡æœ‰translogçš„æŒç»­éšæœºå†™

```
å†™å‰¯æœ¬çš„ç£ç›˜å‹åŠ›æ¥æºï¼š

1. TranslogæŒç»­éšæœºå°å†™ (æœ€å¤§æ€æ‰‹)
   - æ¯ä¸ªæ–‡æ¡£éƒ½å†™å…¥translog
   - 4KB-16KBéšæœºå†™
   - é¢‘ç‡æé«˜ï¼ˆä¸å†™å…¥é€Ÿç‡ç›¸åŒï¼‰
   - ä¸¥é‡å½±å“ç£ç›˜é˜Ÿåˆ—æ·±åº¦

2. Segmentå‘¨æœŸæ€§é¡ºåºå¤§å†™
   - æ¯5ç§’å†™ä¸€æ¬¡
   - 100MBé¡ºåºå†™
   - å¯¹ç£ç›˜å‹å¥½

æœç´¢å‰¯æœ¬çš„ç£ç›˜å‹åŠ›æ¥æºï¼š

1. Segmentå‘¨æœŸæ€§é¡ºåºå¤§å†™ (å”¯ä¸€å†™å…¥)
   - æ¯5ç§’å†™ä¸€æ¬¡
   - 100MBé¡ºåºå†™
   - å¯¹SSDéå¸¸å‹å¥½
   - ä¸å½±å“è¯»å–é˜Ÿåˆ—

ç»“è®ºï¼šæœç´¢å‰¯æœ¬é¿å…äº†æœ€ä¼¤æ€§èƒ½çš„éšæœºå°å†™ï¼
```

#### å…³é”®åŸå›  2ï¼šå¯ä»¥ä¼˜åŒ–ä¸‹è½½ç­–ç•¥

```java
// æœç´¢å‰¯æœ¬å¯ä»¥å®ç°æ™ºèƒ½ä¸‹è½½ç­–ç•¥

// ç­–ç•¥1: å»¶è¿Ÿä¸‹è½½ï¼ˆé¿å¼€æŸ¥è¯¢é«˜å³°ï¼‰
if (currentQueryQPS > highThreshold) {
    // å»¶è¿Ÿsegmentä¸‹è½½ï¼Œç­‰æŸ¥è¯¢é«˜å³°è¿‡å»
    delaySegmentDownload(duration: 5_seconds);
}

// ç­–ç•¥2: é€Ÿç‡é™åˆ¶ï¼ˆä¿ç•™å¸¦å®½ç»™æŸ¥è¯¢ï¼‰
downloadSegmentWithRateLimit(
    maxBandwidth: "100MB/s",  // ä¸å æ»¡å¸¦å®½
    priority: LOW              // ä½ä¼˜å…ˆçº§IO
);

// ç­–ç•¥3: åˆ†æ‰¹ä¸‹è½½ï¼ˆå‡å°‘IOå†²å‡»ï¼‰
downloadSegmentInBatches(
    batchSize: 10_files,
    delayBetweenBatches: 1_second
);
```

**å†™å‰¯æœ¬ä¸èƒ½è¿™æ ·ä¼˜åŒ–**ï¼š
- Translogå¿…é¡»å®æ—¶å†™å…¥ï¼ˆå¦åˆ™æ•°æ®ä¸¢å¤±ï¼‰
- Segmentå¤åˆ¶ä¹Ÿéœ€è¦åŠæ—¶ï¼ˆä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰
- æ— æ³•å»¶è¿Ÿæˆ–é™é€Ÿ

#### å…³é”®åŸå›  3ï¼šå¯ä»¥ä½¿ç”¨ä¸“ç”¨ç½‘ç»œè·¯å¾„

```
æ¶æ„ä¼˜åŒ–ï¼š

å†™å‰¯æœ¬ç½‘ç»œï¼š
  èŠ‚ç‚¹å†…ç½‘ç»œ: 10Gbps (å…±äº«)
  â”œâ”€ æ¥æ”¶translog: å ç”¨3Gbps
  â”œâ”€ æ¥æ”¶segment: å ç”¨2Gbps
  â””â”€ æŸ¥è¯¢æµé‡: 5Gbps (å—æŒ¤å‹ âš ï¸)

æœç´¢å‰¯æœ¬ç½‘ç»œï¼š
  èŠ‚ç‚¹å†…ç½‘ç»œ: 10Gbps
  â”œâ”€ S3ä¸‹è½½ä¸“ç”¨é“¾è·¯: 3Gbps (å¯é™é€Ÿ)
  â””â”€ æŸ¥è¯¢æµé‡: 7Gbps (å……è¶³ âœ…)

  æˆ–ä½¿ç”¨S3 VPC Endpointèµ°ä¸“ç”¨é€šé“ï¼Œ
  ä¸æŸ¥è¯¢æµé‡å®Œå…¨éš”ç¦»
```

---

### Q4: ä¸åŒå†™å…¥å‹åŠ›ä¸‹çš„å‰¯æœ¬é…ç½®å»ºè®®

#### ä½å†™å…¥åœºæ™¯ (<1000 docs/s)

```yaml
é…ç½®å»ºè®®ï¼š
  index.number_of_replicas: 1
  index.number_of_search_replicas: 3-5

æ€§èƒ½ç‰¹ç‚¹ï¼š
  - æœç´¢å‰¯æœ¬å’Œå†™å‰¯æœ¬å»¶è¿Ÿå·®å¼‚ä¸å¤§
  - æœç´¢å‰¯æœ¬æ‰©å±•æ€§ä¼˜åŠ¿æ˜æ˜¾
  - æˆæœ¬ä¼˜åŠ¿æ˜æ˜¾

ç»“è®ºï¼šâœ… å¼ºçƒˆæ¨èä½¿ç”¨æœç´¢å‰¯æœ¬
```

#### ä¸­ç­‰å†™å…¥åœºæ™¯ (1000-10000 docs/s)

```yaml
é…ç½®å»ºè®®ï¼š
  index.number_of_replicas: 1
  index.number_of_search_replicas: 3-5

ä¼˜åŒ–é…ç½®ï¼š
  # é™åˆ¶segmentä¸‹è½½é€Ÿç‡ï¼Œä¿ç•™å¸¦å®½ç»™æŸ¥è¯¢
  indices.recovery.max_bytes_per_sec: 100mb
  indices.recovery.max_concurrent_remote_store_streams: 4

æ€§èƒ½ç‰¹ç‚¹ï¼š
  - æœç´¢å‰¯æœ¬å»¶è¿Ÿï¼šP99 45ms
  - å†™å‰¯æœ¬å»¶è¿Ÿï¼šP99 150ms
  - æœç´¢å‰¯æœ¬ä¼˜åŠ¿æ˜¾è‘—ï¼ˆ3å€å·®è·ï¼‰

ç»“è®ºï¼šâœ… å¼ºçƒˆæ¨èä½¿ç”¨æœç´¢å‰¯æœ¬
```

#### é«˜å†™å…¥åœºæ™¯ (10000-50000 docs/s)

```yaml
é…ç½®å»ºè®®ï¼š
  index.number_of_replicas: 1-2
  index.number_of_search_replicas: 2-3

ä¼˜åŒ–é…ç½®ï¼š
  # ä¸¥æ ¼çš„é€Ÿç‡é™åˆ¶
  indices.recovery.max_bytes_per_sec: 50mb

  # å¢åŠ refreshé—´éš”ï¼Œå‡å°‘segmentç”Ÿæˆé¢‘ç‡
  index.refresh_interval: 10s  # è€Œä¸æ˜¯5s

æ€§èƒ½ç‰¹ç‚¹ï¼š
  - æœç´¢å‰¯æœ¬å»¶è¿Ÿï¼šP99 80ms
  - å†™å‰¯æœ¬å»¶è¿Ÿï¼šP99 250ms
  - æœç´¢å‰¯æœ¬ä»æœ‰ä¼˜åŠ¿ï¼ˆ3å€å·®è·ï¼‰

ç»“è®ºï¼šâœ… æ¨èä½¿ç”¨æœç´¢å‰¯æœ¬ï¼Œä½†éœ€è°ƒä¼˜
```

#### æç«¯å†™å…¥åœºæ™¯ (>50000 docs/s)

```yaml
é…ç½®å»ºè®®ï¼š
  index.number_of_replicas: 2      # å¢åŠ å†™å‰¯æœ¬åˆ†æ‹…è¯»
  index.number_of_search_replicas: 0-1  # å‡å°‘æˆ–ç¦ç”¨æœç´¢å‰¯æœ¬

ä¼˜åŒ–é…ç½®ï¼š
  # å¤§å¹…å¢åŠ refreshé—´éš”
  index.refresh_interval: 30s

  # æˆ–å®Œå…¨ç¦ç”¨æœç´¢å‰¯æœ¬
  index.number_of_search_replicas: 0

æ€§èƒ½ç‰¹ç‚¹ï¼š
  - æœç´¢å‰¯æœ¬å»¶è¿Ÿï¼šP99 150msï¼ˆå¼€å§‹æ˜¾è‘—ä¸‹é™ï¼‰
  - å†™å‰¯æœ¬å»¶è¿Ÿï¼šP99 300ms
  - ä¼˜åŠ¿å‡å¼±

ç»“è®ºï¼šâš ï¸ è€ƒè™‘ä½¿ç”¨å†™å‰¯æœ¬æˆ–æ··åˆæ–¹æ¡ˆ
```

---

### Q5: æœç´¢å‰¯æœ¬çš„å†…å­˜ä½¿ç”¨ä¼˜åŒ–

#### å†…å­˜åˆ†é…å¯¹æ¯”

```java
// å†™å‰¯æœ¬å†…å­˜å ç”¨ï¼ˆ32GBèŠ‚ç‚¹ï¼‰
{
  indexBuffer: 3GB,          // Luceneå†™å…¥ç¼“å†² (heapçš„10%)
  translogBuffer: 512MB,     // translogç¼“å†²
  segmentMemory: 8GB,        // segmentæ•°æ®ï¼ˆå †å¤–ï¼‰
  fieldDataCache: 4GB,       // å­—æ®µç¼“å­˜
  queryCache: 2GB,           // æŸ¥è¯¢ç¼“å­˜
  requestCache: 1GB,         // è¯·æ±‚ç¼“å­˜
  å…¶ä»–: 2GB
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  JVM Heap: 16GB
  æ€»å†…å­˜: ~32GB
}

// æœç´¢å‰¯æœ¬å†…å­˜å ç”¨ï¼ˆ16GBèŠ‚ç‚¹å³å¯ï¼‰
{
  indexBuffer: 0MB,          // æ— å†™å…¥ç¼“å†² âœ… èŠ‚çœ3GB
  translogBuffer: 0MB,       // æ— translog âœ… èŠ‚çœ512MB
  segmentMemory: 8GB,        // segmentæ•°æ®ï¼ˆå †å¤–ï¼‰
  fieldDataCache: 6GB,       // æ›´å¤§çš„å­—æ®µç¼“å­˜ âœ…
  queryCache: 4GB,           // æ›´å¤§çš„æŸ¥è¯¢ç¼“å­˜ âœ…
  requestCache: 2GB,         // æ›´å¤§çš„è¯·æ±‚ç¼“å­˜ âœ…
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  JVM Heap: 12GB (æ›´å¤šç¼“å­˜)
  æ€»å†…å­˜: ~16GB (èŠ‚çœ50%)
}
```

**å…³é”®ä¼˜åŠ¿**ï¼šæœç´¢å‰¯æœ¬å¯ä»¥å°†æ‰€æœ‰å†…å­˜ç”¨äºæœç´¢ä¼˜åŒ–ï¼Œè€Œä¸æ˜¯æµªè´¹åœ¨å†™å…¥ç¼“å†²ä¸Šï¼

---

### Q6: å®é™…æ¡ˆä¾‹åˆ†æ

#### æ¡ˆä¾‹1ï¼šç”µå•†æœç´¢ï¼ˆè¯»å¤šå†™å°‘ï¼‰

```yaml
åœºæ™¯ï¼š
  - æ—¥å‡æŸ¥è¯¢ï¼š1äº¿æ¬¡
  - æ—¥å‡å†™å…¥ï¼š1000ä¸‡æ¬¡
  - è¯»å†™æ¯”ï¼š10:1

é…ç½®Aï¼ˆä»…å†™å‰¯æœ¬ï¼‰ï¼š
  number_of_replicas: 9
  æˆæœ¬ï¼š10èŠ‚ç‚¹ Ã— $100 = $1000/æœˆ
  P99å»¶è¿Ÿï¼š120msï¼ˆå—å†™å…¥å½±å“ï¼‰

é…ç½®Bï¼ˆæœç´¢å‰¯æœ¬ï¼‰ï¼š
  number_of_replicas: 1
  number_of_search_replicas: 9
  æˆæœ¬ï¼š2Ã—$100 + 9Ã—$40 = $560/æœˆ
  P99å»¶è¿Ÿï¼š40msï¼ˆç¨³å®šï¼‰

ç»“è®ºï¼š
  âœ… æˆæœ¬èŠ‚çœï¼š44%
  âœ… æ€§èƒ½æå‡ï¼š3å€
```

#### æ¡ˆä¾‹2ï¼šæ—¥å¿—åˆ†æï¼ˆå†™å¤šè¯»å°‘ï¼‰

```yaml
åœºæ™¯ï¼š
  - æ—¥å‡æŸ¥è¯¢ï¼š1000ä¸‡æ¬¡
  - æ—¥å‡å†™å…¥ï¼š10äº¿æ¬¡
  - è¯»å†™æ¯”ï¼š1:100

é…ç½®ï¼š
  number_of_replicas: 2
  number_of_search_replicas: 0

ç»“è®ºï¼š
  âœ… ç›´æ¥ä½¿ç”¨å†™å‰¯æœ¬å³å¯
  âœ… æ— éœ€å¼•å…¥è¿œç¨‹å­˜å‚¨çš„å¤æ‚åº¦
```

---

### Q7: çœŸå®çš„ç»“è®º

#### æœç´¢å‰¯æœ¬çš„çœŸç›¸

1. âœ… **å¹¶éå®Œå…¨æ²¡æœ‰èµ„æºç«äº‰**
   - é¢‘ç¹ä¸‹è½½segmentä»å ç”¨ç½‘ç»œå’Œç£ç›˜IO
   - åœ¨é«˜å¹¶å‘å†™å…¥æ—¶ï¼ŒæŸ¥è¯¢å»¶è¿Ÿä¹Ÿä¼šä¸Šå‡

2. âœ… **ä½†å½±å“ç¨‹åº¦ç¡®å®æ›´å°**
   - æ ¸å¿ƒåŸå› ï¼šæ²¡æœ‰æŒç»­çš„translogéšæœºå°å†™
   - IOPSéœ€æ±‚å‡å°‘çº¦70%
   - å¯ä»¥é€šè¿‡ç­–ç•¥ä¼˜åŒ–ï¼ˆå»¶è¿Ÿä¸‹è½½ã€é™é€Ÿï¼‰

3. âœ… **åœ¨æç«¯åœºæ™¯ä¸‹ä¼˜åŠ¿å‡å¼±**
   - å†™å…¥>50000 docs/sæ—¶ï¼Œæ€§èƒ½ä¹Ÿä¼šä¸‹é™
   - éœ€è¦é‡æ–°è¯„ä¼°æ¶æ„

#### æœç´¢å‰¯æœ¬çš„æ ¸å¿ƒä¼˜åŠ¿

**ä¸æ˜¯"å®Œå…¨æ²¡æœ‰èµ„æºç«äº‰"ï¼Œè€Œæ˜¯ï¼š**

1. **æ²¡æœ‰translogçš„æŒç»­å†™å…¥å‹åŠ›**ï¼ˆ70% IOPSèŠ‚çœï¼‰
2. **å¯ä»¥çµæ´»æ§åˆ¶segmentä¸‹è½½ç­–ç•¥**ï¼ˆå»¶è¿Ÿã€é™é€Ÿï¼‰
3. **å¯ä»¥ç‹¬ç«‹æ‰©å±•è€Œä¸å¢åŠ ä¸»åˆ†ç‰‡è´Ÿè½½**ï¼ˆæ‰©å±•æ€§ï¼‰
4. **å¯ä»¥ä½¿ç”¨ä½é…èŠ‚ç‚¹**ï¼ˆæˆæœ¬ä¼˜åŒ–50%ï¼‰
5. **å†…å­˜å…¨éƒ¨ç”¨äºæœç´¢ä¼˜åŒ–**ï¼ˆæ€§èƒ½æå‡ï¼‰

---

## ğŸ“ åã€æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æœç´¢å‰¯æœ¬ = å¼ºåˆ¶è¿œç¨‹å­˜å‚¨æ‹‰å–**
   - `isSearchOnly() == true` â†’ å¿…é¡»ä½¿ç”¨ `RemoteStoreReplicationSource`
   - ä¸å‚ä¸å†™å…¥å¤åˆ¶æµç¨‹
   - å®Œå…¨è§£è€¦è¯»å†™è·¯å¾„

2. **å†™å‰¯æœ¬ = å¯é€‰è¿œç¨‹å­˜å‚¨æ‹‰å–**
   - å¦‚æœ `isAssignedOnRemoteNode() == true` â†’ ä½¿ç”¨ `RemoteStoreReplicationSource`
   - å¦‚æœ `isAssignedOnRemoteNode() == false` â†’ ä½¿ç”¨ `PrimaryShardReplicationSource`
   - ç”±é…ç½®å†³å®š

3. **æ€§èƒ½å¯¹æ¯”**
   - è¿œç¨‹å­˜å‚¨ï¼šå¹¶å‘é«˜ã€å¯æ‰©å±•ã€æ— ä¸»åˆ†ç‰‡ç“¶é¢ˆ
   - ä¸»åˆ†ç‰‡ï¼šå»¶è¿Ÿä½ã€æ— å¯¹è±¡å­˜å‚¨æˆæœ¬ã€ä¼ ç»Ÿæ¨¡å¼

4. **æ¶æ„å»ºè®®**
   - å°è§„æ¨¡/å†™å¯†é›†ï¼šä¸»åˆ†ç‰‡â†’å†™å‰¯æœ¬
   - å¤§è§„æ¨¡/è¯»å¯†é›†ï¼šè¿œç¨‹å­˜å‚¨â†’æœç´¢å‰¯æœ¬
   - æ··åˆåœºæ™¯ï¼š1ä¸ªå†™å‰¯æœ¬ + Nä¸ªæœç´¢å‰¯æœ¬

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2025-10-22
**æœ€åæ›´æ–°**: 2025-10-22 (æ–°å¢æ·±åº¦é—®ç­”ç« èŠ‚)
**OpenSearch ç‰ˆæœ¬**: 3.3.x

**å…³é”®ç±»**:
- `RemoteStoreReplicationSource.java`
- `PrimaryShardReplicationSource.java`
- `SegmentReplicationSourceFactory.java`
- `RemoteStoreFileDownloader.java`

**æ›´æ–°æ—¥å¿—**:
- v1.0: åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºç¡€å¯¹æ¯”åˆ†æ
- v1.1: æ–°å¢ç¬¬ä¹ç« "æ·±åº¦é—®ç­”ï¼šå†™å‰¯æœ¬ vs æœç´¢å‰¯æœ¬"ï¼ŒåŒ…å«ï¼š
  - ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨å†™å‰¯æœ¬çš„è¯¦ç»†åˆ†æ
  - æœç´¢å‰¯æœ¬ä¹Ÿä¼šå—å½±å“çš„çœŸå®æ€§èƒ½æ•°æ®
  - ä¸åŒå†™å…¥å‹åŠ›ä¸‹çš„é…ç½®å»ºè®®
  - å®é™…æ¡ˆä¾‹åˆ†æ